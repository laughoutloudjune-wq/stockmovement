<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover, user-scalable=no" />
  <title>ระบบสต็อกวัสดุ</title>

  <!-- FAVICONS (put favicon.png and apple-touch-icon.png next to this file) -->
  <link rel="icon" type="image/png" sizes="32x32" href="favicon.png">
  <link rel="icon" type="image/png" sizes="192x192" href="favicon.png">
  <link rel="apple-touch-icon" href="apple-touch-icon.png">

  <style>
    :root{
      --fs-xs: clamp(0.78rem, 1.3vw, 0.9rem);
      --fs-sm: clamp(0.95rem, 1.6vw, 1.05rem);
      --fs-md: clamp(1.05rem, 2vw, 1.2rem);
      --fs-lg: clamp(1.2rem, 2.4vw, 1.4rem);
      --space-1:.5rem; --space-2:.75rem; --space-3:1rem; --space-4:1.25rem;
      --radius: 1rem; --border: rgba(255,255,255,.35);
      --bg:#eef1f6; --card: rgba(255,255,255,0.6); --text:#0b0b0d;
      --accent:#0a84ff; --accent-weak:#e5f0ff;
      --shadow: 0 10px 30px rgba(0,0,0,.08);
      --container-max: 72rem; --toolbar-max: 44rem;
      --pad-x: max(4vw, 1rem); --pad-bottom: 9.5rem;
    }
    *,*::before,*::after{ box-sizing:border-box }
    html{ height:100%; font-size:16px; -webkit-text-size-adjust:100% }
    body{
      min-height:100dvh; margin:0;
      font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background: linear-gradient(180deg,#eaf0ff 0%, #f7f9ff 100%);
      color:var(--text)
    }

    .container{
      position:relative; z-index:1; width:min(100%, 28rem); margin:0 auto;
      padding: calc(env(safe-area-inset-top) + var(--space-3)) var(--pad-x)
               calc(env(safe-area-inset-bottom) + var(--pad-bottom));
      display:flex; flex-direction:column; gap:var(--space-3)
    }
    @media (min-width: 48rem){ .container{ width:min(100%, var(--container-max)) } }

    .glass{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: saturate(160%) blur(12px);
      -webkit-backdrop-filter: saturate(160%) blur(12px);
    }

    header{ display:flex; align-items:center; gap:var(--space-2) }
    header h1{ margin:0; font-size:var(--fs-lg); font-weight:800 }
    .spacer{ flex:1 }

    .lang{ display:flex; gap:.5rem }
    .lang button{
      padding:.45rem .9rem; border-radius:9999px; border:1px solid rgba(255,255,255,.5);
      background:rgba(255,255,255,.6); color:#111; font-weight:700; font-size:var(--fs-sm); cursor:pointer;
      backdrop-filter: blur(6px); -webkit-backdrop-filter: blur(6px);
    }
    .lang button.active{
      background:linear-gradient(145deg,#0a84ff,#4da3ff);
      color:#fff; border-color:transparent;
      box-shadow: 0 6px 14px rgba(10,132,255,.25), inset 0 0 0 1px rgba(255,255,255,.2)
    }

    .tabs{
      display:flex; gap:.5rem; padding:.4rem; overflow:auto;
      border-radius:9999px;
      background:rgba(255,255,255,0.55);
      border:1px solid rgba(255,255,255,.45);
      backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
      -webkit-overflow-scrolling:touch
    }
    .tabs button{
      flex:0 0 auto; white-space:nowrap; padding:.6rem .9rem; border:none;
      border-radius:9999px; background:transparent; cursor:pointer; font-weight:800;
      color:#1e1e20; font-size:var(--fs-sm)
    }
    .tabs button.active{ background:#fff; color:#0a84ff; box-shadow:var(--shadow) }

    .toolbar{
      position:fixed; left:50%; bottom:calc(env(safe-area-inset-bottom) + 0.75rem);
      transform:translateX(-50%); z-index:1000; width:min(100% - 2rem, var(--toolbar-max));
      display:flex; align-items:center; gap:.5rem; padding:.65rem;
    }
    .toolbar.glass{ border-radius:1rem }

    .btn{
      appearance:none; cursor:pointer; font-weight:800; font-size:var(--fs-sm);
      padding:.85rem 1rem; border-radius:.9rem; border:1px solid rgba(255,255,255,.45);
      background:rgba(255,255,255,0.55); color:#111;
      box-shadow:inset 0 0 0 1px rgba(255,255,255,.6), 0 3px 8px rgba(0,0,0,.08);
      -webkit-tap-highlight-color:transparent; touch-action:manipulation;
      flex:1 1 0; /* WIDE by default (Add + Submit) */
    }
    .btn.primary{
      color:#fff; border-color:transparent;
      background:linear-gradient(145deg,#0a84ff,#4da3ff);
      box-shadow:0 6px 14px rgba(10,132,255,.28), inset 0 0 0 1px rgba(255,255,255,.2)
    }
    .btn.small{
      flex:0 0 auto; /* SMALL only for Reset */
      padding:.45rem .75rem; font-size:var(--fs-xs); font-weight:700;
      background:rgba(255,255,255,0.5);
    }

    .card{ padding:var(--space-3); display:flex; flex-direction:column; gap:var(--space-3) }
    .card h3{ margin:0; font-size:var(--fs-md) }

    .row{ display:flex; flex-wrap:wrap; gap:var(--space-3) }
    .row > *{ flex:1 1 14rem }

    label{ font-size:var(--fs-xs); color:#3f4753 }
    input,select,textarea{
      width:100%; padding:.95rem 1rem; font-size:16px; background:rgba(255,255,255,.85);
      color:#111; border:1px solid rgba(255,255,255,.55); border-radius:.9rem; outline:none;
      backdrop-filter: blur(6px); -webkit-backdrop-filter: blur(6px);
    }
    input:focus,select:focus,textarea:focus{ border-color:#0a84ff; box-shadow:0 0 0 .2rem var(--accent-weak) }

    .lines{ display:flex; flex-direction:column; gap:.75rem }
    .line{
      display:flex; flex-direction:column; gap:.65rem; padding:.75rem;
      border:1px dashed rgba(255,255,255,.55); border-radius:.9rem; background:rgba(255,255,255,.55);
      backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
    }
    .line .grid{ display:flex; flex-wrap:wrap; gap:.75rem }
    .line .grid > *{ flex:1 1 10rem }
    .actions{ display:flex; justify-content:flex-end }

    .list{ display:flex; flex-direction:column; gap:.6rem }
    .rowitem{
      display:flex; justify-content:space-between; align-items:center; gap:.75rem;
      padding:.75rem 1rem; border:1px solid rgba(255,255,255,.5); border-radius:.9rem;
      background:rgba(255,255,255,.6); font-size:var(--fs-sm);
      backdrop-filter: blur(6px); -webkit-backdrop-filter: blur(6px);
    }
    .rowitem .meta{ color:#556070; font-size:var(--fs-xs) }

    .grid-dash{ display:flex; flex-direction:column; gap:var(--space-3) }
    @media (min-width: 80rem){ .grid-dash{ flex-direction:row }
      .grid-dash > :first-child{ flex:2 1 0 } .grid-dash > :last-child{ flex:1 1 0 } }

    .kpis{ display:flex; gap:.5rem; flex-wrap:wrap }
    .kpi{
      flex:1 1 9rem; padding:.8rem; border-radius:.9rem; border:1px solid rgba(255,255,255,.45);
      background:rgba(255,255,255,.55); box-shadow:var(--shadow); backdrop-filter: blur(8px)
    }
    .kpi .v{ font-size:1.25rem; font-weight:800 }

    .toggle{ display:flex; justify-content:flex-end }
    .toggle button{ border:none; background:transparent; color:#0a84ff; font-weight:700; cursor:pointer; padding:.25rem .25rem }

    /* Stock badge */
    .badge{
      display:inline-flex; align-items:center; justify-content:center;
      min-width:1.9rem; height:1.9rem; padding:0 .4rem; border-radius:9999px; font-size:.9rem; font-weight:800;
      color:#fff; background:#7b8794;
    }
    .badge.red{ background:#ef4444 }
    .badge.yellow{ background:#f59e0b }
    .badge.green{ background:#10b981 }

    /* Picker Overlay */
    #pickerOverlay{
      position:fixed; inset:0; z-index:2000; display:none;
      align-items:center; justify-content:center;
      background:rgba(15,18,23,0.35);
      backdrop-filter: blur(3px); -webkit-backdrop-filter: blur(3px);
    }
    #pickerOverlay.open{ display:flex }
    #pickerBox{
      background:rgba(255,255,255,.7); border:1px solid rgba(255,255,255,.45);
      border-radius:16px; box-shadow:0 20px 50px rgba(0,0,0,.18);
      display:flex; flex-direction:column; width:100%; height:100%; overflow:hidden;
      backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
    }
    .picker-header{ display:flex; gap:.5rem; align-items:center; padding:.75rem; border-bottom:1px solid rgba(255,255,255,.4); background:rgba(255,255,255,.55) }
    .picker-header input{
      flex:1; padding:.9rem 1rem; font-size:16px; border:1px solid rgba(255,255,255,.65); border-radius:.9rem; outline:none;
      background:rgba(255,255,255,.9)
    }
    .picker-list{ flex:1; overflow:auto; -webkit-overflow-scrolling:touch; padding:.6rem .75rem; display:flex; flex-direction:column; gap:.5rem; background:rgba(255,255,255,.4) }
    .pick-row{
      padding:.95rem 1rem; font-size:1.02rem; line-height:1.25; border:1px solid rgba(255,255,255,.55); border-radius:.85rem; background:rgba(255,255,255,.9);
      word-break:break-word; backdrop-filter: blur(6px)
    }
    .picker-actions{ border-top:1px solid rgba(255,255,255,.4); padding:.6rem .75rem; background:rgba(255,255,255,.55); display:flex; gap:.5rem }
    @media (min-width: 769px){ #pickerBox{ width:520px; height:70vh } }

    .toast{
      position:fixed; left:50%; bottom:calc(env(safe-area-inset-bottom) + 4.5rem);
      transform:translateX(-50%); background:#111; color:#fff; padding:.7rem 1rem; border-radius:.9rem;
      display:none; z-index:2500; font-size:var(--fs-sm); box-shadow:0 12px 30px rgba(0,0,0,.16)
    }
    .toast.show{ display:block }
  </style>
</head>
<body>
<div class="container" id="app">
  <header>
    <h1 id="t_title">ระบบสต็อกวัสดุ</h1>
    <div class="spacer"></div>
    <div class="lang">
      <button id="lang-th" class="active" type="button">ไทย</button>
      <button id="lang-en" type="button">EN</button>
    </div>
  </header>

  <div class="tabs glass">
    <button id="tab-dashboard" class="active" type="button">สรุป</button>
    <button id="tab-out" type="button">จ่ายออก</button>
    <button id="tab-in" type="button">รับเข้า</button>
    <button id="tab-adjust" type="button">ปรับปรุง</button>
    <button id="tab-purchase" type="button">ขอจัดซื้อ</button>
  </div>

  <!-- DASHBOARD -->
  <section id="panel-dashboard" class="grid-dash">
    <div>
      <div class="card glass">
        <h3 id="t_dash_lowstock">สต็อกใกล้หมด</h3>
        <div class="list" id="lowStockList" data-limit="5"></div>
        <div class="toggle"><button type="button" data-toggle="#lowStockList">ดูเพิ่มเติม</button></div>
      </div>
      <div class="card glass">
        <h3 id="t_dash_topcontractors">ผู้รับเหมาที่ใช้บ่อย</h3>
        <div class="list" id="topContractors" data-limit="5"></div>
        <div class="toggle"><button type="button" data-toggle="#topContractors">ดูเพิ่มเติม</button></div>
      </div>
      <div class="card glass">
        <h3 id="t_pur_summary">สรุปการขอจัดซื้อ</h3>
        <div class="kpis">
          <div class="kpi glass"><div class="v" id="kpiReq">0</div><div>คำขอ</div></div>
          <div class="kpi glass"><div class="v" id="kpiLines">0</div><div>รายการ</div></div>
          <div class="kpi glass"><div class="v" id="kpiUrgent">0</div><div>ด่วน</div></div>
        </div>
        <div class="list" id="purSummaryDetail" data-limit="5"></div>
        <div class="toggle"><button type="button" data-toggle="#purSummaryDetail">ดูเพิ่มเติม</button></div>
      </div>
    </div>
    <div>
      <div class="card glass">
        <h3 id="t_dash_topitems">วัสดุยอดใช้</h3>
        <div class="list" id="topItems" data-limit="5"></div>
        <div class="toggle"><button type="button" data-toggle="#topItems">ดูเพิ่มเติม</button></div>
      </div>
      <div class="card glass">
        <h3 id="t_dash_recent">ความเคลื่อนไหวล่าสุด</h3>
        <div class="list" id="recentMoves" data-limit="5"></div>
        <div class="toggle"><button type="button" data-toggle="#recentMoves">ดูเพิ่มเติม</button></div>
      </div>
      <div class="card glass">
        <h3 id="t_pur_history">ประวัติการขอจัดซื้อ</h3>
        <div class="list" id="purHistory" data-limit="5"></div>
        <div class="toggle"><button type="button" data-toggle="#purHistory">ดูเพิ่มเติม</button></div>
      </div>
    </div>
  </section>

  <!-- OUT shared header -->
  <div class="card glass" id="sharedCard">
    <div class="row">
      <div>
        <label id="t_project">โครงการ / สถานที่</label>
        <input id="ProjectInput" data-picker="projects" placeholder="ค้นหาหรือเลือก" readonly />
      </div>
      <div>
        <label id="t_contractor">ผู้รับเหมา</label>
        <div style="display:flex;gap:.5rem;align-items:center">
          <input id="ContractorInput" data-picker="contractors" placeholder="เลือกหรือเพิ่มใหม่" readonly />
          <button class="btn" style="flex:0 0 auto; min-width:2.5rem" id="addContractorBtn" type="button">+</button>
        </div>
      </div>
    </div>
    <div class="row">
      <div>
        <label id="t_requester">ผู้ขอเบิก</label>
        <div style="display:flex;gap:.5rem;align-items:center">
          <input id="RequesterInput" data-picker="requesters" placeholder="เลือกหรือเพิ่มใหม่" readonly />
          <button class="btn" style="flex:0 0 auto; min-width:2.5rem" id="addRequesterBtn" type="button">+</button>
        </div>
      </div>
      <div>
        <label id="t_note">หมายเหตุ</label>
        <input id="Note" placeholder="ถ้ามี" />
      </div>
    </div>
  </div>

  <!-- OUT -->
  <div class="card glass" id="panel-out" style="display:none">
    <h3 id="t_out_title">จ่ายออก</h3>
    <div class="row">
      <div>
        <label id="t_out_date">วันที่</label>
        <input id="OutDate" type="date" />
      </div>
    </div>
    <div class="lines" id="outLines"></div>
  </div>

  <!-- IN -->
  <div class="card glass" id="panel-in" style="display:none">
    <h3 id="t_in_title">รับเข้า</h3>
    <div class="row">
      <div>
        <label id="t_date">วันที่รับ</label>
        <input id="InDate" type="date" />
      </div>
    </div>
    <div class="lines" id="inLines"></div>
  </div>

  <!-- ADJUST -->
  <div class="card glass" id="panel-adjust" style="display:none">
    <h3 id="t_adjust_title">ปรับปรุงสต็อก</h3>
    <div class="lines" id="adjLines"></div>
  </div>

  <!-- PURCHASING -->
  <div class="card glass" id="panel-purchase" style="display:none">
    <h3 id="t_pur_title">ขอจัดซื้อ</h3>
    <div class="row" style="margin-top:.25rem">
      <div>
        <label id="t_pur_project">โครงการ / สถานที่</label>
        <input id="PurProject" data-picker="projects" placeholder="ค้นหาหรือเลือก" readonly />
      </div>
      <div>
        <label id="t_pur_needby">ต้องการภายใน (วัน)</label>
        <input type="date" id="PurNeedBy" />
      </div>
    </div>
    <div class="row">
      <div>
        <label id="t_pur_contractor">ผู้รับเหมา</label>
        <input id="PurContractor" data-picker="contractors" placeholder="เลือกหรือเพิ่ม" readonly />
      </div>
      <div>
        <label id="t_pur_priority">ความเร่งด่วน</label>
        <select id="PurPriority">
          <option value="Normal">ปกติ</option>
          <option value="Urgent">ด่วน</option>
          <option value="Critical">วิกฤติ</option>
        </select>
      </div>
    </div>
    <div class="lines" id="purLines"></div>
    <div class="row">
      <div>
        <label id="t_pur_note">หมายเหตุคำขอ</label>
        <input id="PurNote" placeholder="บันทึกเพิ่มเติม (ถ้ามี)" />
      </div>
    </div>

    <div class="card glass" style="margin-top:.25rem">
      <h3>คำขอเดิม</h3>
      <div class="list" id="purOlderList" data-limit="10"></div>
      <div class="toggle"><button type="button" data-toggle="#purOlderList">ดูเพิ่มเติม</button></div>
    </div>
  </div>
</div>

<!-- Floating toolbar (glass) — WIDE (Add + Submit), Reset small -->
<div class="toolbar glass" id="toolbar" aria-live="polite" role="region">
  <button class="btn" id="addLineBtn" type="button" title="เพิ่มรายการ">＋ เพิ่ม</button>
  <button class="btn small" id="resetBtn" type="button">ล้าง</button>
  <button class="btn primary" id="submitBtn" type="button">บันทึก</button>
</div>

<div id="toast" class="toast" role="status" aria-live="polite"></div>

<!-- Picker Overlay -->
<div id="pickerOverlay" aria-hidden="true">
  <div id="pickerBox" role="dialog" aria-modal="true">
    <div class="picker-header">
      <input id="pickerSearch" placeholder="ค้นหา…" inputmode="search" />
      <button class="btn" id="pickerCancel" type="button">ปิด</button>
    </div>
    <div class="picker-list" id="pickerList"></div>
    <div class="picker-actions">
      <button class="btn" id="pickerAdd" type="button" title="เพิ่มใหม่">เพิ่ม “<span id="pickerAddText"></span>”</button>
    </div>
  </div>
</div>

<script>
(function(){
  /* ===== API CONFIG (your Apps Script web app) ===== */
  const API_URL = "https://script.google.com/macros/s/AKfycbwEJDNfo63e0LjEZa-bhXmX3aY2PUs96bUBGz186T-pVlphV4NGNYxGT2tcx1DWgbDI/exec";

  const safeJson = t => { try { return JSON.parse(t); } catch(e){ return {ok:false,error:'Bad JSON'}; } };
  function apiGet(fn, payload, cb){
    const q = new URLSearchParams(); q.set('fn',fn);
    if (payload && Object.keys(payload).length) q.set('payload', JSON.stringify(payload));
    fetch(API_URL + "?" + q.toString(), { method:'GET' })
      .then(r=>r.text()).then(safeJson).then(d=>cb && cb(d)).catch(e=>console.error(fn,e));
  }
  function apiPost(fn, payload, cb){
    fetch(API_URL, {
      method:'POST', headers:{'Content-Type':'text/plain;charset=utf-8'},
      body: JSON.stringify({fn:fn, payload:payload||{}})
    }).then(r=>r.text()).then(safeJson).then(d=>cb && cb(d)).catch(e=>console.error(fn,e));
  }

  const $ = q => document.querySelector(q);
  const $$ = q => Array.prototype.slice.call(document.querySelectorAll(q));
  function toast(m){ const t=$('#toast'); t.textContent=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 4500); }
  const esc = v => (v==null)?'':String(v).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  const todayStr = () => new Date().toISOString().split('T')[0];

  function clampList(listEl){
    const max = Number(listEl.dataset.limit||'5');
    const items = listEl.children;
    for (let i=0;i<items.length;i++){ items[i].style.display = (i<max) ? '' : 'none'; }
    listEl.dataset.expanded = 'false';
  }
  function toggleClamp(btn){
    const sel = btn.getAttribute('data-toggle');
    const list = $(sel); if(!list) return;
    const expanded = list.dataset.expanded === 'true';
    const items = list.children;
    for (let i=0;i<items.length;i++){
      items[i].style.display = expanded ? ((i<Number(list.dataset.limit||'5'))? '' : 'none') : '';
    }
    list.dataset.expanded = expanded ? 'false' : 'true';
    btn.textContent = expanded ? (LANG==='th'?'ดูเพิ่มเติม':'Show more') : (LANG==='th'?'ย่อ':'Show less');
  }

  // i18n (Thai default)
  const STR = {
    th:{
      title:'ระบบสต็อกวัสดุ',
      tabs:{dash:'สรุป', out:'จ่ายออก', in:'รับเข้า', adj:'ปรับปรุง', pur:'ขอจัดซื้อ'},
      searchPh:'พิมพ์เพื่อค้นหา…', pick:'ค้นหาหรือเลือก', pickAdd:'เลือกหรือเพิ่มใหม่',
      proj:'โครงการ / สถานที่', contractor:'ผู้รับเหมา', requester:'ผู้ขอเบิก', note:'หมายเหตุ',
      outTitle:'จ่ายออก', outDate:'วันที่', inTitle:'รับเข้า', inDate:'วันที่รับ', adjTitle:'ปรับปรุงสต็อก',
      btnAdd:'＋ เพิ่ม', btnReset:'ล้าง', btnSubmit:'บันทึก',
      dashLow:'สต็อกใกล้หมด', dashTopContract:'ผู้รับเหมาที่ใช้บ่อย', dashTopItems:'วัสดุยอดใช้', dashRecent:'ความเคลื่อนไหวล่าสุด',
      purTitle:'ขอจัดซื้อ', purProj:'โครงการ / สถานที่', purNeedBy:'ต้องการภายใน (วัน)', purContractor:'ผู้รับเหมา',
      purPriority:'ความเร่งด่วน', purNote:'หมายเหตุคำขอ', purOlder:'คำขอเดิม',
      showMore:'ดูเพิ่มเติม', showLess:'ย่อ', noLow:'ไม่มีรายการใกล้หมด 🎉',
      stock:'คงเหลือ: ', prev:'คงเหลือก่อนหน้า: ', dashNoSubmit:'หน้านี้ไม่มีรายการให้บันทึก',
    },
    en:{
      title:'Inventory', tabs:{dash:'Dashboard', out:'OUT', in:'IN', adj:'ADJUST', pur:'PURCHASING'},
      searchPh:'Type to search…', pick:'Search or pick', pickAdd:'Pick or add',
      proj:'Project / Location', contractor:'Contractor', requester:'Requester', note:'Note',
      outTitle:'Material OUT', outDate:'Date', inTitle:'Material IN', inDate:'Date received', adjTitle:'Adjust',
      btnAdd:'＋ Add', btnReset:'Reset', btnSubmit:'Submit',
      dashLow:'Low stock', dashTopContract:'Top contractors (usage)', dashTopItems:'Top items', dashRecent:'Recent movements',
      purTitle:'Purchasing Request', purProj:'Project / Location', purNeedBy:'Need by (date)', purContractor:'Contractor',
      purPriority:'Priority', purNote:'Request note', purOlder:'Older Requests',
      showMore:'Show more', showLess:'Show less', noLow:'No low stock 🎉',
      stock:'Stock: ', prev:'Prev: ', dashNoSubmit:'Nothing to submit on Dashboard',
    }
  };
  let LANG='th';

  function applyLang(){
    const S = STR[LANG];
    $('#t_title').textContent = S.title;
    $('#tab-dashboard').textContent = S.tabs.dash;
    $('#tab-out').textContent = S.tabs.out;
    $('#tab-in').textContent = S.tabs.in;
    $('#tab-adjust').textContent = S.tabs.adj;
    $('#tab-purchase').textContent = S.tabs.pur;
    $('label#t_project').textContent = S.proj;
    $('label#t_contractor').textContent = S.contractor;
    $('label#t_requester').textContent = S.requester;
    $('label#t_note').textContent = S.note;
    $('#ProjectInput').placeholder = S.pick;
    $('#ContractorInput').placeholder = S.pickAdd;
    $('#RequesterInput').placeholder = S.pickAdd;
    $('#t_out_title').textContent = S.outTitle;
    $('#t_out_date').textContent = S.outDate;
    $('#t_in_title').textContent = S.inTitle;
    $('#t_date').textContent = S.inDate;
    $('#t_adjust_title').textContent = S.adjTitle;
    $('#t_dash_lowstock').textContent = S.dashLow;
    $('#t_dash_topcontractors').textContent = S.dashTopContract;
    $('#t_dash_topitems').textContent = S.dashTopItems;
    $('#t_dash_recent').textContent = S.dashRecent;
    $('#t_pur_title').textContent = S.purTitle;
    $('#t_pur_project').textContent = S.purProj;
    $('#t_pur_needby').textContent = S.purNeedBy;
    $('#t_pur_contractor').textContent = S.purContractor;
    $('#t_pur_priority').textContent = S.purPriority;
    $('#t_pur_note').textContent = S.purNote;
    $('#resetBtn').textContent = S.btnReset;
    $('#submitBtn').textContent = S.btnSubmit;
    $('#addLineBtn').textContent = S.btnAdd;
    $$('.toggle button').forEach(b=>{ b.textContent = S.showMore; });
  }

  // Lookups
  let MATERIALS=[], PROJECTS=[], CONTRACTORS=[], REQUESTERS=[];

  /* ===== Picker Overlay ===== */
  const pickerOverlay = $('#pickerOverlay');
  const pickerList = $('#pickerList');
  const pickerSearch = $('#pickerSearch');
  const pickerAdd = $('#pickerAdd');
  const pickerAddText = $('#pickerAddText');
  const pickerCancel = $('#pickerCancel');

  const sources = {
    materials: () => MATERIALS,
    projects:  () => PROJECTS,
    contractors: () => CONTRACTORS,
    requesters: () => REQUESTERS
  };

  let currentTargetInput = null;
  let currentSourceKey = null;

  function openPicker(targetInput, sourceKey){
    currentTargetInput = targetInput;
    currentSourceKey = sourceKey;
    pickerSearch.value = '';
    renderPickerList('');
    pickerOverlay.classList.add('open');
    pickerOverlay.setAttribute('aria-hidden','false');
    setTimeout(()=>pickerSearch.focus(), 50);
  }
  function closePicker(){
    pickerOverlay.classList.remove('open');
    pickerOverlay.setAttribute('aria-hidden','true');
    currentTargetInput = null;
    currentSourceKey = null;
  }
  function renderPickerList(query){
    const all = (sources[currentSourceKey] ? sources[currentSourceKey]() : []) || [];
    const q = (query||'').toLowerCase().trim();
    const list = q ? all.filter(v => String(v).toLowerCase().includes(q)) : all.slice();
    pickerList.innerHTML = '';

    if (!list.length){
      pickerAdd.classList.remove('hidden');
      pickerAddText.textContent = query || '';
    } else {
      pickerAdd.classList.add('hidden');
    }

    list.forEach(v=>{
      const row = document.createElement('div');
      row.className = 'pick-row';
      row.innerHTML = '<strong>'+esc(v)+'</strong>';
      row.addEventListener('click', ()=>{
        if (currentTargetInput){ currentTargetInput.value = v; currentTargetInput.dispatchEvent(new Event('change')); }
        closePicker();
      });
      pickerList.appendChild(row);
    });
  }
  pickerSearch.addEventListener('input', e => renderPickerList(e.target.value));
  pickerCancel.addEventListener('click', closePicker);
  pickerOverlay.addEventListener('click', e=>{ if(e.target===pickerOverlay) closePicker(); });
  document.addEventListener('keydown', e=>{ if(e.key==='Escape' && pickerOverlay.classList.contains('open')) closePicker(); });

  pickerAdd.addEventListener('click', ()=>{
    const text = pickerSearch.value.trim();
    if (!text) return;
    if (currentSourceKey === 'contractors'){
      apiGet('addContractor', {name:text}, ok=>{
        if (ok){ CONTRACTORS = Array.from(new Set([text, ...CONTRACTORS])); toast(LANG==='th'?'เพิ่มผู้รับเหมาแล้ว':'Added contractor'); }
        if (currentTargetInput) { currentTargetInput.value = text; currentTargetInput.dispatchEvent(new Event('change')); }
        closePicker();
      });
    } else if (currentSourceKey === 'requesters'){
      apiGet('addRequester', {name:text}, ok=>{
        if (ok){ REQUESTERS = Array.from(new Set([text, ...REQUESTERS])); toast(LANG==='th'?'เพิ่มผู้ขอแล้ว':'Added requester'); }
        if (currentTargetInput) { currentTargetInput.value = text; currentTargetInput.dispatchEvent(new Event('change')); }
        closePicker();
      });
    } else {
      toast(LANG==='th'?'กรุณาเพิ่มในชีทมาสเตอร์':'Use master sheet to add new entries');
      closePicker();
    }
  });
  function bindPickerInputs(){
    $$('input[data-picker]').forEach(inp=>{
      inp.addEventListener('click', ()=>{
        const key = inp.getAttribute('data-picker');
        openPicker(inp, key);
      });
    });
  }

  /* ===== Stock badge helper ===== */
  function stockBadge(stock, min){
    const b=document.createElement('span');
    b.className='badge';
    b.textContent = (stock==null || isNaN(stock)) ? '-' : stock;
    if (stock<=0 || (min!=null && stock<=Number(min||0))) b.classList.add('red');
    else if (min!=null && stock <= 2*Number(min||0)) b.classList.add('yellow');
    else b.classList.add('green');
    return b;
  }

  /* ===== Line builders ===== */
  function outLine(){
    const card=document.createElement('div'); card.className='line';
    const name=document.createElement('input'); name.placeholder=(LANG==='th' ? STR.th.searchPh : STR.en.searchPh); name.readOnly=true; name.setAttribute('data-picker','materials');
    const qty=document.createElement('input'); qty.type='number'; qty.min='0'; qty.step='any'; qty.placeholder='0'; qty.inputMode='decimal';
    const grid=document.createElement('div'); grid.className='grid'; grid.appendChild(name); grid.appendChild(qty);
    const meta=document.createElement('div'); meta.className='rowitem'; meta.style.justifyContent='flex-start';
    const label=document.createElement('span'); label.className='meta'; label.textContent=(LANG==='th' ? 'คงเหลือ:' : 'Stock: ');
    const badge=document.createElement('span'); badge.className='badge'; badge.textContent='-';
    meta.appendChild(label); meta.appendChild(badge);
    const actions=document.createElement('div'); actions.className='actions';
    const rm=document.createElement('button'); rm.type='button'; rm.className='btn'; rm.style.flex='0 0 auto'; rm.textContent='×'; rm.onclick=()=>card.remove();
    actions.appendChild(rm);
    card.appendChild(grid); card.appendChild(meta); card.appendChild(actions);
    name.addEventListener('click', ()=>openPicker(name,'materials'));
    name.addEventListener('change', ()=>{ const v=name.value.trim(); if(!v) return;
      apiGet('getCurrentStock',{material:v}, res=>{
        const n = (res && res.ok) ? Number(res.stock) : null;
        const bNew = stockBadge(n, null);
        meta.replaceChild(bNew, badge);
      });
    });
    return card;
  }
  function inLine(){
    const card=document.createElement('div'); card.className='line';
    const name=document.createElement('input'); name.placeholder=(LANG==='th' ? STR.th.searchPh : STR.en.searchPh); name.readOnly=true; name.setAttribute('data-picker','materials');
    const qty=document.createElement('input'); qty.type='number'; qty.min='0'; qty.step='any'; qty.placeholder='0'; qty.inputMode='decimal';
    const grid=document.createElement('div'); grid.className='grid'; grid.appendChild(name); grid.appendChild(qty);
    const actions=document.createElement('div'); actions.className='actions';
    const rm=document.createElement('button'); rm.type='button'; rm.className='btn'; rm.style.flex='0 0 auto'; rm.textContent='×'; rm.onclick=()=>card.remove();
    actions.appendChild(rm);
    card.appendChild(grid); card.appendChild(actions);
    name.addEventListener('click', ()=>openPicker(name,'materials'));
    return card;
  }
  function adjLine(){
    const card=document.createElement('div'); card.className='line';
    const name=document.createElement('input'); name.placeholder=(LANG==='th' ? STR.th.searchPh : STR.en.searchPh); name.readOnly=true; name.setAttribute('data-picker','materials');
    const qty=document.createElement('input'); qty.type='number'; qty.step='any'; qty.placeholder='±'; qty.inputMode='decimal';
    const grid=document.createElement('div'); grid.className='grid'; grid.appendChild(name); grid.appendChild(qty);
    const meta=document.createElement('div'); meta.className='rowitem'; meta.style.justifyContent='flex-start';
    const label=document.createElement('span'); label.className='meta'; label.textContent=(LANG==='th' ? 'คงเหลือก่อนหน้า:' : 'Prev: ');
    const badge=document.createElement('span'); badge.className='badge'; badge.textContent='-';
    meta.appendChild(label); meta.appendChild(badge);
    const actions=document.createElement('div'); actions.className='actions';
    const rm=document.createElement('button'); rm.type='button'; rm.className='btn'; rm.style.flex='0 0 auto'; rm.textContent='×'; rm.onclick=()=>card.remove();
    actions.appendChild(rm);
    card.appendChild(grid); card.appendChild(meta); card.appendChild(actions);
    name.addEventListener('click', ()=>openPicker(name,'materials'));
    name.addEventListener('change', ()=>{ const v=name.value.trim(); if(!v) return;
      apiGet('getCurrentStock',{material:v}, res=>{
        const n = (res && res.ok) ? Number(res.stock) : null;
        const bNew = stockBadge(n, null);
        meta.replaceChild(bNew, badge);
      });
    });
    return card;
  }
  function purLine(){
    const card=document.createElement('div'); card.className='line';
    const name=document.createElement('input'); name.placeholder=(LANG==='th' ? STR.th.searchPh : STR.en.searchPh); name.readOnly=true; name.setAttribute('data-picker','materials');
    const qty=document.createElement('input'); qty.type='number'; qty.min='0'; qty.step='any'; qty.placeholder='0'; qty.inputMode='decimal';
    const spec=document.createElement('input'); spec.placeholder=(LANG==='th'?'สเปก / ยี่ห้อ (ถ้ามี)':'Spec / Brand (optional)'); spec.style.width='100%';
    const grid=document.createElement('div'); grid.className='grid'; grid.appendChild(name); grid.appendChild(qty); grid.appendChild(spec);
    const actions=document.createElement('div'); actions.className='actions';
    const rm=document.createElement('button'); rm.type='button'; rm.className='btn'; rm.style.flex='0 0 auto'; rm.textContent='×'; rm.onclick=()=>card.remove();
    actions.appendChild(rm);
    card.appendChild(grid); card.appendChild(actions);
    name.addEventListener('click', ()=>openPicker(name,'materials'));
    return card;
  }

  function collectLines(containerSel){
    const out=[];
    $$(containerSel+' .line').forEach(c=>{
      const nameEl=c.querySelector('input[data-picker="materials"]');
      const qtyEl=c.querySelector('input[type="number"]');
      const specEl=c.querySelector('input[placeholder^="สเปก"],input[placeholder^="Spec"]');
      const name=nameEl?nameEl.value.trim():'';
      const qty=Number(qtyEl?qtyEl.value:0)||0;
      const spec=specEl? (specEl.value.trim()||'') : '';
      if (name) out.push({name:name, qty:qty, spec:spec});
    });
    return out;
  }

  function currentTab(){
    if ($('#panel-dashboard').style.display!=='none') return 'dashboard';
    if ($('#panel-out').style.display!=='none') return 'out';
    if ($('#panel-in').style.display!=='none') return 'in';
    if ($('#panel-adjust').style.display!=='none') return 'adjust';
    return 'purchase';
  }
  function showTab(which){
    ['#tab-dashboard','#tab-out','#tab-in','#tab-adjust','#tab-purchase'].forEach(s=>{ const b=$(s); if(b) b.classList.remove('active'); });
    ['#panel-dashboard','#panel-out','#panel-in','#panel-adjust','#panel-purchase'].forEach(s=>{ const p=$(s); p.style.display='none'; });
    $('#sharedCard').classList.add('hidden');

    if (which==='dashboard'){ $('#tab-dashboard').classList.add('active'); $('#panel-dashboard').style.display='flex'; $('#toolbar').classList.add('hidden'); loadDashboard(); }
    if (which==='out'){ $('#tab-out').classList.add('active'); $('#panel-out').style.display='flex'; $('#sharedCard').classList.remove('hidden'); $('#toolbar').classList.remove('hidden'); }
    if (which==='in'){ $('#tab-in').classList.add('active'); $('#panel-in').style.display='flex'; $('#toolbar').classList.remove('hidden'); }
    if (which==='adjust'){ $('#tab-adjust').classList.add('active'); $('#panel-adjust').style.display='flex'; $('#toolbar').classList.remove('hidden'); }
    if (which==='purchase'){ $('#tab-purchase').classList.add('active'); $('#panel-purchase').style.display='flex'; $('#toolbar').classList.remove('hidden'); loadPurchasingOlder(); }
  }

  function submit(){
    const tab = currentTab();
    if (tab==='dashboard'){ toast(STR[LANG].dashNoSubmit); return; }

    if (tab==='purchase'){
      const pp = {
        type:'PURCHASE',
        project: $('#PurProject').value.trim(),
        contractor: $('#PurContractor').value.trim(),
        needBy:  $('#PurNeedBy').value.trim(),
        priority: $('#PurPriority').value,
        note:     $('#PurNote').value.trim(),
        lines:    collectLines('#purLines')
      };
      if (!pp.lines.length){ toast(LANG==='th'?'กรุณาเพิ่มรายการ':'Add at least one line'); return; }
      apiPost('submitPurchaseRequest', pp, res=>{
        if(res && res.ok){ toast((LANG==='th'?'ส่งคำขอแล้ว • ':'Request sent • ')+(res.docNo||'')); hardReset('purchase'); loadDashboard(); }
        else toast((res && res.message) || 'Error');
      });
      return;
    }

    const payload = {
      type: (tab==='out') ? 'OUT' : (tab==='in') ? 'IN' : 'ADJUST',
      project: (tab==='out') ? $('#ProjectInput').value.trim() : '',
      contractor: (tab==='out') ? $('#ContractorInput').value.trim() : '',
      requester: (tab==='out') ? $('#RequesterInput').value.trim() : '',
      note: (tab==='out') ? $('#Note').value.trim() : '',
      date: (tab==='in') ? $('#InDate').value.trim() : (tab==='out' ? $('#OutDate').value.trim() : ''),
      lines: (tab==='in') ? collectLines('#inLines') : (tab==='out') ? collectLines('#outLines') : collectLines('#adjLines')
    };
    if (!payload.lines.length){ toast(LANG==='th'?'กรุณาเพิ่มรายการ':'Add at least one line'); return; }

    apiPost('submitMovementBulk', payload, res=>{
      if(res && res.ok){ toast((LANG==='th'?'บันทึกแล้ว • เอกสาร ':'Saved • Doc ')+(res.docNo||'')); hardReset(tab); loadDashboard(); }
      else toast((res && res.message) || 'Error');
    });
  }

  function hardReset(which){
    const d=todayStr();
    if (!which || which==='out'){ $('#outLines').innerHTML=''; $('#outLines').appendChild(outLine()); $('#Note').value=''; $('#OutDate').value=d; }
    if (!which || which==='in'){  $('#inLines').innerHTML='';  $('#inLines').appendChild(inLine());  $('#InDate').value=d; }
    if (!which || which==='adjust'){ $('#adjLines').innerHTML=''; $('#adjLines').appendChild(adjLine()); }
    if (!which || which==='purchase'){ $('#purLines').innerHTML=''; $('#purLines').appendChild(purLine()); $('#PurNote').value=''; $('#PurNeedBy').value=d; $('#PurContractor').value=''; }
    window.scrollTo({top:0,behavior:'smooth'});
  }

  // ===== Dashboard fills =====
  function loadDashboard(){
    apiGet('dash_LowStock', {}, list=>{
      const box = $('#lowStockList'); box.innerHTML='';
      if (!list || !list.length){ box.innerHTML = '<div class="rowitem"><span>'+ (LANG==='th' ? STR.th.noLow : STR.en.noLow) +'</span></div>'; return clampList(box); }
      list.forEach(x=>{
        const row=document.createElement('div'); row.className='rowitem';
        const left=document.createElement('div');
        const title=document.createElement('div'); title.innerHTML='<strong>'+esc(x.name)+'</strong>';
        const meta=document.createElement('div'); meta.className='meta'; meta.textContent='Min '+(x.min==null?'-':x.min);
        left.appendChild(title); left.appendChild(meta);
        const right=stockBadge(Number(x.stock), Number(x.min));
        row.appendChild(left); row.appendChild(right);
        box.appendChild(row);
      });
      clampList(box);
    });
    apiGet('dash_TopContractors', {}, list=>{
      const box = $('#topContractors'); box.innerHTML='';
      (list||[]).forEach(x=>{
        const row=document.createElement('div'); row.className='rowitem';
        row.innerHTML = '<div><strong>'+esc(x.contractor||'(unknown)')+'</strong><div class="meta">Qty '+(x.qty||0)+'</div></div>';
        box.appendChild(row);
      });
      clampList(box);
    });
    apiGet('dash_TopItems', {}, list=>{
      const box = $('#topItems'); box.innerHTML='';
      (list||[]).forEach(x=>{
        const row=document.createElement('div'); row.className='rowitem';
        row.innerHTML = '<div><strong>'+esc(x.name)+'</strong><div class="meta">Used • '+esc(x.qty)+'</div></div>';
        box.appendChild(row);
      });
      clampList(box);
    });
    apiGet('dash_Recent', {}, rows=>{
      const box = $('#recentMoves'); box.innerHTML='';
      (rows||[]).forEach(x=>{
        const row=document.createElement('div'); row.className='rowitem';
        row.innerHTML = '<div><strong>'+esc(x.type)+' • '+esc(x.item)+'</strong><div class="meta">'+esc(x.ts)+' — '+esc(x.doc)+' • Qty '+esc(x.qty)+'</div></div>';
        box.appendChild(row);
      });
      clampList(box);
    });
    apiGet('pur_Summary', {}, s=>{
      $('#kpiReq').textContent = (s && s.requests) ? s.requests : 0;
      $('#kpiLines').textContent = (s && s.lines) ? s.lines : 0;
      $('#kpiUrgent').textContent = (s && s.urgent) ? s.urgent : 0;
    });
    apiGet('pur_History', {}, rows=>{
      const sum = $('#purSummaryDetail'); sum.innerHTML='';
      (rows||[]).forEach(x=>{
        const row=document.createElement('div'); row.className='rowitem';
        row.innerHTML = '<div><strong>'+esc(x.docNo)+' • '+esc(x.project||'-')+'</strong>'+
                        '<div class="meta">👷 '+esc(x.contractor||'-')+' • 🙋 '+esc(x.requester||'-')+'</div>'+
                        '<div class="meta">🗓 '+esc(x.ts)+' → 📆 '+esc(x.needBy||'-')+'</div></div>';
        sum.appendChild(row);
      });
      clampList(sum);

      const box = $('#purHistory'); box.innerHTML='';
      (rows||[]).forEach(x=>{
        const row=document.createElement('div'); row.className='rowitem';
        row.innerHTML = '<div><strong>'+esc(x.docNo)+' • '+esc(x.project||'-')+'</strong>'+
                        '<div class="meta">'+esc(x.ts)+' • NeedBy '+esc(x.needBy||'-')+' • '+esc(x.priority||'-')+' • '+esc(x.status||'-')+'</div>'+
                        '<div class="meta">Lines '+esc(x.lines)+' • Qty '+esc(x.totalQty)+' • 👷 '+esc(x.contractor||'-')+' • 🙋 '+esc(x.requester||'-')+'</div></div>';
        box.appendChild(row);
      });
      clampList(box);
    });

    $$('.toggle button').forEach(btn=> btn.onclick = ()=>toggleClamp(btn));
  }

  // ===== Purchasing tab: Older Requests with STATUS UPDATE =====
  function loadPurchasingOlder(){
    apiGet('pur_History', {}, rows=>{
      const box=$('#purOlderList'); box.innerHTML='';
      (rows||[]).forEach(x=>{
        const acc=document.createElement('div'); acc.className='rowitem';
        acc.style.flexDirection='column'; acc.style.alignItems='stretch';
        const head=document.createElement('div');
        head.style.display='flex'; head.style.justifyContent='space-between'; head.style.cursor='pointer';
        head.innerHTML = '<span>'+esc(x.docNo)+' • '+esc(x.project||'-')+' • '+esc(x.ts)+'</span><span>›</span>';

        const body=document.createElement('div'); body.className='hidden';
        body.innerHTML = `
          <div class="meta">👷 ${esc(x.contractor||'-')} • 🙋 ${esc(x.requester||'-')}</div>
          <div class="meta">NeedBy ${esc(x.needBy||'-')} • สถานะ: <strong>${esc(x.status||'-')}</strong></div>
          <div style="display:flex; gap:.5rem; align-items:center; margin:.5rem 0;">
            <label style="min-width:7rem">${LANG==='th'?'เปลี่ยนสถานะ':'Change status'}</label>
            <select id="status-${esc(x.docNo)}" style="flex:1">
              <option value="Requested" ${x.status==="Requested"?"selected":""}>Requested</option>
              <option value="Approved" ${x.status==="Approved"?"selected":""}>Approved</option>
              <option value="Ordered" ${x.status==="Ordered"?"selected":""}>Ordered</option>
              <option value="Received" ${x.status==="Received"?"selected":""}>Received</option>
              <option value="Cancelled" ${x.status==="Cancelled"?"selected":""}>Cancelled</option>
            </select>
            <button class="btn" id="save-${esc(x.docNo)}" type="button">${LANG==='th'?'บันทึก':'Save'}</button>
          </div>
          <div id="doc-${esc(x.docNo)}">${LANG==='th'?'กำลังโหลด…':'Loading…'}</div>
        `;

        // save button event
        setTimeout(()=>{
          const saveBtn = body.querySelector('#save-'+CSS.escape(x.docNo));
          const sel = body.querySelector('#status-'+CSS.escape(x.docNo));
          saveBtn.addEventListener('click', ()=>{
            apiPost('pur_UpdateStatus', {docNo:x.docNo, status:sel.value}, res=>{
              if(res && res.ok){
                toast((LANG==='th'?'อัปเดตสถานะแล้ว → ':'Status updated → ')+sel.value);
                loadDashboard();
                loadPurchasingOlder();
              } else {
                toast(res && res.message || 'Error');
              }
            });
          });
        },100);

        head.addEventListener('click', ()=>{
          const open = !body.classList.contains('hidden');
          if (open){ body.classList.add('hidden'); return; }
          const holder = body.querySelector('#doc-'+CSS.escape(x.docNo));
          apiGet('pur_DocLines', {docNo:x.docNo}, lines=>{
            const tbl = document.createElement('table'); tbl.className='table';
            tbl.style.width='100%'; tbl.style.borderCollapse='collapse';
            tbl.innerHTML='<thead><tr><th>รายการ</th><th>สเปก</th><th>จำนวน</th></tr></thead>';
            const tb=document.createElement('tbody');
            (lines||[]).forEach(li=>{
              const tr=document.createElement('tr');
              tr.innerHTML='<td>'+esc(li.item)+'</td><td>'+esc(li.spec||'')+'</td><td>'+esc(li.qty)+'</td>';
              tb.appendChild(tr);
            });
            tbl.appendChild(tb);
            holder.replaceWith(tbl);
          });
          body.classList.remove('hidden');
        });
        acc.appendChild(head); acc.appendChild(body);
        box.appendChild(acc);
      });
      clampList(box);
      const toggleBtn = document.querySelector('.toggle button[data-toggle="#purOlderList"]');
      if (toggleBtn) toggleBtn.onclick = ()=>toggleClamp(toggleBtn);
    });
  }

  // Events
  document.addEventListener('DOMContentLoaded', function(){
    // default language = Thai
    $('#lang-th').classList.add('active'); $('#lang-en').classList.remove('active');
    applyLang();

    // language switch
    $('#lang-en').addEventListener('click', ()=>{ LANG='en'; $('#lang-en').classList.add('active'); $('#lang-th').classList.remove('active'); applyLang(); });
    $('#lang-th').addEventListener('click', ()=>{ LANG='th'; $('#lang-th').classList.add('active'); $('#lang-en').classList.remove('active'); applyLang(); });

    // tabs
    $('#tab-dashboard').addEventListener('click', ()=>{ showTab('dashboard'); loadDashboard(); });
    $('#tab-out').addEventListener('click', ()=>{ showTab('out'); });
    $('#tab-in').addEventListener('click', ()=>{ showTab('in'); });
    $('#tab-adjust').addEventListener('click', ()=>{ showTab('adjust'); });
    $('#tab-purchase').addEventListener('click', ()=>{ showTab('purchase'); });

    // toolbar buttons
    $('#addLineBtn').addEventListener('click', ()=>{
      const tab=currentTab();
      if (tab==='out') $('#outLines').appendChild(outLine());
      else if (tab==='in') $('#inLines').appendChild(inLine());
      else if (tab==='adjust') $('#adjLines').appendChild(adjLine());
      else if (tab==='purchase') $('#purLines').appendChild(purLine());
      else toast(STR[LANG].dashNoSubmit);
      bindPickerInputs();
    });
    $('#resetBtn').addEventListener('click', ()=>{ hardReset(currentTab()); bindPickerInputs(); });
    $('#submitBtn').addEventListener('click', submit);

    // lookups
    apiGet('listMaterials', {}, a=>{ MATERIALS=a||[]; });
    apiGet('listProjects', {}, a=>{ PROJECTS=a||[]; });
    apiGet('listContractors', {}, a=>{ CONTRACTORS=a||[]; });
    apiGet('listRequesters', {}, a=>{ REQUESTERS=a||[]; });

    // initial
    hardReset(); // sets dates to today
    showTab('dashboard');
    loadDashboard();
    bindPickerInputs();

    // header pickers
    $('#ProjectInput').addEventListener('click', ()=>openPicker($('#ProjectInput'),'projects'));
    $('#ContractorInput').addEventListener('click', ()=>openPicker($('#ContractorInput'),'contractors'));
    $('#RequesterInput').addEventListener('click', ()=>openPicker($('#RequesterInput'),'requesters'));
    $('#PurProject').addEventListener('click', ()=>openPicker($('#PurProject'),'projects'));
    $('#PurContractor').addEventListener('click', ()=>openPicker($('#PurContractor'),'contractors'));

    // quick-add
    $('#addContractorBtn').addEventListener('click', ()=>{
      openPicker($('#ContractorInput'),'contractors'); pickerSearch.focus();
    });
    $('#addRequesterBtn').addEventListener('click', ()=>{
      openPicker($('#RequesterInput'),'requesters'); pickerSearch.focus();
    });
  });
})();
</script>
</body>
</html>
