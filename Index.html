<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
<title>Inventory</title>
<style>
  :root{
    --fs-xs: clamp(0.78rem, 1.3vw, 0.9rem);
    --fs-sm: clamp(0.95rem, 1.6vw, 1.05rem);
    --fs-md: clamp(1.05rem, 2vw, 1.2rem);
    --fs-lg: clamp(1.2rem, 2.4vw, 1.4rem);
    --space-1:.5rem; --space-2:.75rem; --space-3:1rem; --space-4:1.25rem;
    --radius: 1rem; --border:#e5e5ea;
    --bg:#f5f5f7; --card:#ffffff; --text:#111; --muted:#6b7280;
    --accent:#0a84ff; --accent-weak:#e5f0ff;
    --shadow: 0 0.05rem 0.15rem rgba(0,0,0,.06), 0 0.6rem 1.2rem rgba(0,0,0,.06);
    --container-max: 72rem; --toolbar-max: 44rem;
    --pad-x: max(4vw, 1rem); --pad-bottom: 10rem;
  }
  *,*::before,*::after{ box-sizing:border-box }
  html{ height:100%; font-size:16px; -webkit-text-size-adjust:100% }
  body{ min-height:100dvh; margin:0; font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif; background:var(--bg); color:var(--text) }

  .container{ position:relative; z-index:1; width:min(100%, 28rem); margin:0 auto;
    padding: calc(env(safe-area-inset-top) + var(--space-3)) var(--pad-x)
             calc(env(safe-area-inset-bottom) + var(--pad-bottom));
    display:flex; flex-direction:column; gap:var(--space-3) }
  @media (min-width: 48rem){ .container{ width:min(100%, var(--container-max)) } }

  header{ display:flex; align-items:center; gap:var(--space-2) }
  header h1{ margin:0; font-size:var(--fs-lg); font-weight:800 }
  .spacer{ flex:1 }

  .lang{ display:flex; gap:.5rem }
  .lang button{ padding:.45rem .9rem; border-radius:9999px; border:1px solid var(--border);
    background:#fafafa; color:#111; font-weight:700; font-size:var(--fs-sm); cursor:pointer }
  .lang button.active{ background:var(--accent); color:#fff; border-color:var(--accent) }

  .tabs{ display:flex; gap:.5rem; padding:.4rem; overflow:auto; border:1px solid var(--border);
    border-radius:9999px; background:#f8f8fb; -webkit-overflow-scrolling:touch }
  .tabs button{ flex:0 0 auto; white-space:nowrap; padding:.6rem .9rem; border:none;
    border-radius:9999px; background:transparent; cursor:pointer; font-weight:800;
    color:#3a3a3c; font-size:var(--fs-sm) }
  .tabs button.active{ background:#fff; color:var(--accent); box-shadow:var(--shadow) }

  .toolbar{ position:fixed; left:50%; bottom:calc(env(safe-area-inset-bottom) + 0.75rem);
    transform:translateX(-50%); z-index:1000; width:min(100% - 2rem, var(--toolbar-max));
    display:inline-flex; align-items:center; gap:.5rem; padding:.65rem; border-radius:1rem;
    background:rgba(255,255,255,0.72); border:1px solid rgba(255,255,255,0.45);
    backdrop-filter:saturate(200%) blur(24px);
    -webkit-backdrop-filter:saturate(200%) blur(24px);
    box-shadow:0 10px 30px rgba(0,0,0,.12) }
  .toolbar.hidden{ display:none }
  .btn{ appearance:none; cursor:pointer; font-weight:800; font-size:var(--fs-sm);
    padding:.8rem 1rem; border-radius:.9rem; flex:1; border:1px solid rgba(255,255,255,.55);
    background:rgba(255,255,255,0.55); color:#111;
    box-shadow:inset 0 0 0 1px rgba(255,255,255,.6), 0 3px 8px rgba(0,0,0,.08);
    -webkit-tap-highlight-color:transparent; touch-action:manipulation }
  .btn.primary{ color:#fff; border-color:transparent;
    background:linear-gradient(145deg,#0a84ff,#4da3ff);
    box-shadow:0 6px 14px rgba(10,132,255,.28), inset 0 0 0 1px rgba(255,255,255,.2) }
  .btn.icon{ flex:0 0 auto; width:2.75rem; min-width:2.75rem; padding:.65rem 0; text-align:center }

  .card{ background:var(--card); border:1px solid var(--border); border-radius:var(--radius);
    box-shadow:var(--shadow); padding:var(--space-3); display:flex; flex-direction:column; gap:var(--space-3) }
  .card h3{ margin:0; font-size:var(--fs-md) }

  .row{ display:flex; flex-wrap:wrap; gap:var(--space-3) }
  .row > *{ flex:1 1 14rem }

  label{ font-size:var(--fs-xs); color:var(--muted) }
  input,select,textarea{ width:100%; padding:.95rem 1rem; font-size:16px; background:#fff; color:#111;
    border:1px solid var(--border); border-radius:.9rem; outline:none }
  input:focus,select:focus,textarea:focus{ border-color:var(--accent); box-shadow:0 0 0 .2rem var(--accent-weak) }

  .lines{ display:flex; flex-direction:column; gap:.75rem }
  .line{ display:flex; flex-direction:column; gap:.75rem; padding:.75rem; border:1px dashed var(--border);
    border-radius:.9rem; background:#fff }
  .line .grid{ display:flex; flex-wrap:wrap; gap:.75rem }
  .line .grid > *{ flex:1 1 10rem }
  .actions{ display:flex; justify-content:flex-end }

  .list{ display:flex; flex-direction:column; gap:.6rem }
  .rowitem{ display:flex; justify-content:space-between; align-items:center; gap:.75rem;
    padding:.75rem 1rem; border:1px solid var(--border); border-radius:.9rem;
    background:#fff; font-size:var(--fs-sm) }
  .rowitem .meta{ color:var(--muted); font-size:var(--fs-xs) }

  .grid-dash{ display:flex; flex-direction:column; gap:var(--space-3) }
  @media (min-width: 80rem){ .grid-dash{ flex-direction:row }
    .grid-dash > :first-child{ flex:2 1 0 } .grid-dash > :last-child{ flex:1 1 0 } }

  .kpis{ display:flex; gap:.5rem; flex-wrap:wrap }
  .kpi{ flex:1 1 9rem; padding:.8rem; border-radius:.9rem; border:1px solid var(--border);
    background:#fff; box-shadow:var(--shadow) }
  .kpi .v{ font-size:1.25rem; font-weight:800 }

  .toggle{ display:flex; justify-content:flex-end }
  .toggle button{ border:none; background:transparent; color:#0a84ff; font-weight:700;
    cursor:pointer; padding:.25rem .25rem }

  /* ===== Mobile Picker (replaces datalist) ===== */
  .picker{
    position:fixed; inset:0; z-index:2000; display:none; background:rgba(0,0,0,.24);
    -webkit-backdrop-filter: blur(2px); backdrop-filter: blur(2px);
  }
  .picker.open{ display:block }
  .picker-sheet{
    position:absolute; left:0; right:0; bottom:0;
    background:#fff; border-top-left-radius:1rem; border-top-right-radius:1rem;
    box-shadow:0 -10px 30px rgba(0,0,0,.15);
    padding: .75rem .75rem calc(env(safe-area-inset-bottom)+.75rem);
    max-height: 85dvh; display:flex; flex-direction:column; gap:.5rem;
  }
  .picker-handle{ height:6px; width:52px; background:#e5e5ea; border-radius:999px; margin:.25rem auto .5rem auto }
  .picker-head{ display:flex; align-items:center; gap:.5rem }
  .picker-head input{ flex:1; padding:.85rem 1rem; border-radius:.9rem; border:1px solid var(--border); font-size:16px }
  .picker-list{ overflow:auto; -webkit-overflow-scrolling:touch; display:flex; flex-direction:column; gap:.35rem; margin-top:.25rem }
  .pick-row{
    padding:.95rem 1rem; font-size:1.02rem; line-height:1.25;
    border:1px solid var(--border); border-radius:.85rem; background:#fff; word-break:break-word;
  }
  .pick-row strong{ font-weight:700 }
  .pick-row .sub{ display:block; color:#6b7280; font-size:.85rem; margin-top:.15rem }
  .picker-actions{ display:flex; gap:.5rem; margin-top:.4rem }
  .picker-actions .btn{ flex:1 }

  .hidden{ display:none !important }
  .toast{ position:fixed; left:50%; bottom:calc(env(safe-area-inset-bottom) + 4.5rem);
    transform:translateX(-50%); background:#111; color:#fff; padding:.6rem .95rem; border-radius:.9rem;
    display:none; z-index:2500; font-size:var(--fs-sm) }
  .toast.show{ display:block }
</style>
</head>
<body>
<div class="container" id="app">
  <header>
    <h1 id="t_title">Inventory</h1>
    <div class="spacer"></div>
    <div class="lang">
      <button id="lang-en" class="active" type="button">EN</button>
      <button id="lang-th" type="button">TH</button>
    </div>
  </header>

  <div class="tabs">
    <button id="tab-dashboard" class="active" type="button">Dashboard</button>
    <button id="tab-out" type="button">OUT</button>
    <button id="tab-in" type="button">IN</button>
    <button id="tab-adjust" type="button">ADJUST</button>
    <button id="tab-purchase" type="button">PURCHASING</button>
  </div>

  <!-- DASHBOARD -->
  <section id="panel-dashboard" class="grid-dash">
    <div>
      <div class="card">
        <h3 id="t_dash_lowstock">Low stock</h3>
        <div class="list" id="lowStockList" data-limit="5"></div>
        <div class="toggle"><button type="button" data-toggle="#lowStockList">Show more</button></div>
      </div>

      <div class="card">
        <h3 id="t_dash_topcontractors">Top contractors (usage)</h3>
        <div class="list" id="topContractors" data-limit="5"></div>
        <div class="toggle"><button type="button" data-toggle="#topContractors">Show more</button></div>
      </div>

      <!-- KPIs + detailed summary -->
      <div class="card">
        <h3 id="t_pur_summary">Purchasing Summary</h3>
        <div class="kpis" id="purKpis">
          <div class="kpi"><div class="v" id="kpiReq">0</div><div>Requests</div></div>
          <div class="kpi"><div class="v" id="kpiLines">0</div><div>Lines</div></div>
          <div class="kpi"><div class="v" id="kpiUrgent">0</div><div>Urgent</div></div>
        </div>
        <div class="list" id="purSummaryDetail" data-limit="5"></div>
        <div class="toggle"><button type="button" data-toggle="#purSummaryDetail">Show more</button></div>
      </div>
    </div>

    <div>
      <div class="card">
        <h3 id="t_dash_topitems">Top items</h3>
        <div class="list" id="topItems" data-limit="5"></div>
        <div class="toggle"><button type="button" data-toggle="#topItems">Show more</button></div>
      </div>

      <div class="card">
        <h3 id="t_dash_recent">Recent movements</h3>
        <div class="list" id="recentMoves" data-limit="5"></div>
        <div class="toggle"><button type="button" data-toggle="#recentMoves">Show more</button></div>
      </div>

      <div class="card">
        <h3 id="t_pur_history">Purchasing History</h3>
        <div class="list" id="purHistory" data-limit="5"></div>
        <div class="toggle"><button type="button" data-toggle="#purHistory">Show more</button></div>
      </div>
    </div>
  </section>

  <!-- OUT shared header -->
  <div class="card" id="sharedCard">
    <div class="row">
      <div>
        <label id="t_project">Project / Location</label>
        <input id="ProjectInput" data-picker="projects" placeholder="Search or pick" readonly />
      </div>
      <div>
        <label id="t_contractor">Contractor</label>
        <div style="display:flex;gap:.5rem;align-items:center">
          <input id="ContractorInput" data-picker="contractors" placeholder="Pick or add" readonly />
          <button class="btn icon" id="addContractorBtn" type="button">+</button>
        </div>
      </div>
    </div>
    <div class="row">
      <div>
        <label id="t_requester">Requester</label>
        <div style="display:flex;gap:.5rem;align-items:center">
          <input id="RequesterInput" data-picker="requesters" placeholder="Pick or add" readonly />
          <button class="btn icon" id="addRequesterBtn" type="button">+</button>
        </div>
      </div>
      <div>
        <label id="t_note">Note</label>
        <input id="Note" placeholder="Optional" />
      </div>
    </div>
  </div>

  <!-- OUT -->
  <div class="card" id="panel-out" style="display:none">
    <h3 id="t_out_title">Material OUT</h3>
    <div class="row">
      <div>
        <label id="t_out_date">Date</label>
        <input id="OutDate" type="date" />
      </div>
    </div>
    <div class="lines" id="outLines"></div>
  </div>

  <!-- IN -->
  <div class="card" id="panel-in" style="display:none">
    <h3 id="t_in_title">Material IN</h3>
    <div class="row">
      <div>
        <label id="t_date">Date received</label>
        <input id="InDate" type="date" />
      </div>
    </div>
    <div class="lines" id="inLines"></div>
  </div>

  <!-- ADJUST -->
  <div class="card" id="panel-adjust" style="display:none">
    <h3 id="t_adjust_title">Adjust</h3>
    <div class="lines" id="adjLines"></div>
  </div>

  <!-- PURCHASING -->
  <div class="card" id="panel-purchase" style="display:none">
    <h3 id="t_pur_title">Purchasing Request</h3>
    <div class="row" style="margin-top:.25rem">
      <div>
        <label id="t_pur_project">Project / Location</label>
        <input id="PurProject" data-picker="projects" placeholder="Search or pick" readonly />
      </div>
      <div>
        <label id="t_pur_needby">Need by (date)</label>
        <input type="date" id="PurNeedBy" />
      </div>
    </div>
    <div class="row">
      <div>
        <label id="t_pur_contractor">Contractor</label>
        <input id="PurContractor" data-picker="contractors" placeholder="Pick or add contractor" readonly />
      </div>
      <div>
        <label id="t_pur_priority">Priority</label>
        <select id="PurPriority">
          <option value="Normal">Normal</option>
          <option value="Urgent">Urgent</option>
          <option value="Critical">Critical</option>
        </select>
      </div>
    </div>
    <div class="lines" id="purLines"></div>
    <div class="row">
      <div>
        <label id="t_pur_note">Request note</label>
        <input id="PurNote" placeholder="Optional note for purchasing team" />
      </div>
    </div>

    <div class="card" style="margin-top:.25rem">
      <h3>Older Requests</h3>
      <div class="list" id="purOlderList" data-limit="10"></div>
      <div class="toggle"><button type="button" data-toggle="#purOlderList">Show more</button></div>
    </div>
  </div>
</div>

<!-- Floating toolbar -->
<div class="toolbar" id="toolbar" aria-live="polite" role="region">
  <button class="btn icon" id="addLineBtn" type="button" title="Add line">Ôºã</button>
  <button class="btn" id="resetBtn" type="button">Reset</button>
  <button class="btn primary" id="submitBtn" type="button">Submit</button>
</div>

<div id="toast" class="toast" role="status" aria-live="polite"></div>

<!-- ===== Mobile Picker markup ===== -->
<div class="picker" id="picker">
  <div class="picker-sheet" role="dialog" aria-modal="true">
    <div class="picker-handle" aria-hidden="true"></div>
    <div class="picker-head">
      <input id="pickerSearch" placeholder="Search‚Ä¶" inputmode="search" />
      <button class="btn" id="pickerCancel" type="button">Cancel</button>
    </div>
    <div class="picker-list" id="pickerList"></div>
    <div class="picker-actions">
      <button class="btn" id="pickerAdd" type="button" title="Add new">Add ‚Äú<span id="pickerAddText"></span>‚Äù</button>
    </div>
  </div>
</div>

<script>
(function(){
  /* ===== API CONFIG ===== */
  const API_URL = "https://script.google.com/macros/s/AKfycbxorXbbVhEW-xW1UPUxhBOJFfc02c2FmEnDbWWZSEEEp-L5OrK3uBF1nSFyuV-Ah58K/exec";

  // ---- API helpers (GET read, POST write; text/plain to avoid preflight) ----
  const safeJson = t => { try { return JSON.parse(t); } catch(e){ return {ok:false,error:'Bad JSON'}; } };
  function apiGet(fn, payload, cb){
    const q = new URLSearchParams(); q.set('fn',fn);
    if (payload && Object.keys(payload).length) q.set('payload', JSON.stringify(payload));
    fetch(API_URL + "?" + q.toString(), { method:'GET' })
      .then(r=>r.text()).then(safeJson).then(d=>cb && cb(d)).catch(e=>console.error(fn,e));
  }
  function apiPost(fn, payload, cb){
    fetch(API_URL, {
      method:'POST', headers:{'Content-Type':'text/plain;charset=utf-8'},
      body: JSON.stringify({fn:fn, payload:payload||{}})
    }).then(r=>r.text()).then(safeJson).then(d=>cb && cb(d)).catch(e=>console.error(fn,e));
  }

  // ---- UI helpers ----
  const $ = q => document.querySelector(q);
  const $$ = q => Array.prototype.slice.call(document.querySelectorAll(q));
  function toast(m){ const t=$('#toast'); t.textContent=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 1800); }
  const esc = v => (v==null)?'':String(v).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  const val = s => { const el=$(s); return el? (el.value||'').trim() : ''; };

  // ---- Clamp lists (Show more / less) ----
  function clampList(listEl){
    const max = Number(listEl.dataset.limit||'5');
    const items = listEl.children;
    for (let i=0;i<items.length;i++){ items[i].style.display = (i<max) ? '' : 'none'; }
    listEl.dataset.expanded = 'false';
  }
  function toggleClamp(btn){
    const sel = btn.getAttribute('data-toggle');
    const list = $(sel); if(!list) return;
    const expanded = list.dataset.expanded === 'true';
    const items = list.children;
    for (let i=0;i<items.length;i++){
      items[i].style.display = expanded ? ((i<Number(list.dataset.limit||'5'))? '' : 'none') : '';
    }
    list.dataset.expanded = expanded ? 'false' : 'true';
    btn.textContent = expanded ? 'Show more' : 'Show less';
  }

  // ---- i18n (kept minimal here) ----
  const STR = {
    en:{title:'Inventory', typeToSearch:'Type to search‚Ä¶', stock:'Stock: ', prev:'Prev: ', dashNoSubmit:'Nothing to submit on Dashboard'},
    th:{title:'‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ß‡∏±‡∏™‡∏î‡∏∏', typeToSearch:'‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‚Ä¶', stock:'‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ', prev:'‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤: ', dashNoSubmit:'‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å'}
  };
  let LANG='en';
  function setText(s,t){ const el=$(s); if(el) el.textContent=t; }
  function applyLang(){ setText('#t_title', STR[LANG].title); }

  // ---- Lookups (arrays) ----
  let MATERIALS=[], PROJECTS=[], CONTRACTORS=[], REQUESTERS=[];

  // ===== Mobile Picker logic =====
  const picker = $('#picker');
  const pickerList = $('#pickerList');
  const pickerSearch = $('#pickerSearch');
  const pickerAdd = $('#pickerAdd');
  const pickerAddText = $('#pickerAddText');
  const pickerCancel = $('#pickerCancel');

  // mapping ‚Äúsource key‚Äù -> array
  const sources = {
    materials: () => MATERIALS,
    projects:  () => PROJECTS,
    contractors: () => CONTRACTORS,
    requesters: () => REQUESTERS
  };

  let currentTargetInput = null;
  let currentSourceKey = null;

  function openPicker(targetInput, sourceKey){
    currentTargetInput = targetInput;
    currentSourceKey = sourceKey;
    pickerSearch.value = '';
    renderPickerList('');
    picker.classList.add('open');
    setTimeout(()=>pickerSearch.focus(), 50);
  }

  function closePicker(){
    picker.classList.remove('open');
    currentTargetInput = null;
    currentSourceKey = null;
  }

  function renderPickerList(query){
    const all = (sources[currentSourceKey] ? sources[currentSourceKey]() : []) || [];
    const q = (query||'').toLowerCase().trim();
    const list = q ? all.filter(v => String(v).toLowerCase().includes(q)) : all.slice();
    pickerList.innerHTML = '';

    if (!list.length){
      pickerAdd.classList.remove('hidden');
      pickerAddText.textContent = query || '';
    } else {
      pickerAdd.classList.add('hidden');
    }

    list.forEach(v=>{
      const row = document.createElement('div');
      row.className = 'pick-row';
      row.innerHTML = '<strong>'+esc(v)+'</strong>';
      row.addEventListener('click', ()=>{
        if (currentTargetInput){ currentTargetInput.value = v; }
        closePicker();
      });
      pickerList.appendChild(row);
    });
  }

  pickerSearch.addEventListener('input', e => renderPickerList(e.target.value));
  pickerCancel.addEventListener('click', closePicker);
  picker.addEventListener('click', e => {
    // close if tap backdrop, not inner sheet
    if (e.target === picker) closePicker();
  });

  // Add new (Contractor/Requester) from picker
  pickerAdd.addEventListener('click', ()=>{
    const text = pickerSearch.value.trim();
    if (!text) return;
    if (currentSourceKey === 'contractors'){
      apiGet('addContractor', {name:text}, ok=>{
        if (ok){ CONTRACTORS = Array.from(new Set([text, ...CONTRACTORS])); toast('Added contractor'); }
        if (currentTargetInput) currentTargetInput.value = text;
        closePicker();
      });
    } else if (currentSourceKey === 'requesters'){
      apiGet('addRequester', {name:text}, ok=>{
        if (ok){ REQUESTERS = Array.from(new Set([text, ...REQUESTERS])); toast('Added requester'); }
        if (currentTargetInput) currentTargetInput.value = text;
        closePicker();
      });
    } else {
      // For projects/materials we don't allow adding from UI (stick to master sheet)
      toast('Use master sheet to add new entries');
      closePicker();
    }
  });

  // attach picker to inputs with data-picker
  function bindPickerInputs(){
    $$('input[data-picker]').forEach(inp=>{
      inp.addEventListener('click', ()=>{
        const key = inp.getAttribute('data-picker');
        openPicker(inp, key);
      });
    });
  }

  // ===== Core app: (only the places related to autocomplete changed) =====

  function outLine(){
    const card=document.createElement('div'); card.className='line';
    const name=document.createElement('input'); name.placeholder=STR[LANG].typeToSearch; name.readOnly=true; name.setAttribute('data-picker','materials');
    const qty=document.createElement('input'); qty.type='number'; qty.min='0'; qty.step='any'; qty.placeholder='0'; qty.inputMode='decimal';
    const grid=document.createElement('div'); grid.className='grid'; grid.appendChild(name); grid.appendChild(qty);
    const meta=document.createElement('div'); meta.className='rowitem meta'; meta.style.justifyContent='flex-start'; meta.textContent=STR[LANG].stock+'‚Äì';
    const actions=document.createElement('div'); actions.className='actions';
    const rm=document.createElement('button'); rm.type='button'; rm.className='btn icon'; rm.textContent='√ó'; rm.onclick=()=>card.remove();
    actions.appendChild(rm);
    card.appendChild(grid); card.appendChild(meta); card.appendChild(actions);
    name.addEventListener('click', ()=>openPicker(name,'materials'));
    name.addEventListener('change', ()=>{ const v=name.value.trim(); if(!v) return; apiGet('getCurrentStock',{material:v}, n=>{ meta.textContent=STR[LANG].stock+n; }); });
    return card;
  }
  function inLine(){
    const card=document.createElement('div'); card.className='line';
    const name=document.createElement('input'); name.placeholder=STR[LANG].typeToSearch; name.readOnly=true; name.setAttribute('data-picker','materials');
    const qty=document.createElement('input'); qty.type='number'; qty.min='0'; qty.step='any'; qty.placeholder='0'; qty.inputMode='decimal';
    const grid=document.createElement('div'); grid.className='grid'; grid.appendChild(name); grid.appendChild(qty);
    const actions=document.createElement('div'); actions.className='actions';
    const rm=document.createElement('button'); rm.type='button'; rm.className='btn icon'; rm.textContent='√ó'; rm.onclick=()=>card.remove();
    actions.appendChild(rm);
    card.appendChild(grid); card.appendChild(actions);
    name.addEventListener('click', ()=>openPicker(name,'materials'));
    return card;
  }
  function adjLine(){
    const card=document.createElement('div'); card.className='line';
    const name=document.createElement('input'); name.placeholder=STR[LANG].typeToSearch; name.readOnly=true; name.setAttribute('data-picker','materials');
    const qty=document.createElement('input'); qty.type='number'; qty.step='any'; qty.placeholder='¬±'; qty.inputMode='decimal';
    const grid=document.createElement('div'); grid.className='grid'; grid.appendChild(name); grid.appendChild(qty);
    const meta=document.createElement('div'); meta.className='rowitem meta'; meta.style.justifyContent='flex-start'; meta.textContent=STR[LANG].prev+'‚Äì';
    const actions=document.createElement('div'); actions.className='actions';
    const rm=document.createElement('button'); rm.type='button'; rm.className='btn icon'; rm.textContent='√ó'; rm.onclick=()=>card.remove();
    actions.appendChild(rm);
    card.appendChild(grid); card.appendChild(meta); card.appendChild(actions);
    name.addEventListener('click', ()=>openPicker(name,'materials'));
    name.addEventListener('change', ()=>{ const v=name.value.trim(); if(!v) return; apiGet('getCurrentStock',{material:v}, n=>{ meta.textContent=STR[LANG].prev+n; }); });
    return card;
  }
  function purLine(){
    const card=document.createElement('div'); card.className='line';
    const name=document.createElement('input'); name.placeholder=STR[LANG].typeToSearch; name.readOnly=true; name.setAttribute('data-picker','materials');
    const qty=document.createElement('input'); qty.type='number'; qty.min='0'; qty.step='any'; qty.placeholder='0'; qty.inputMode='decimal';
    const spec=document.createElement('input'); spec.placeholder='Spec / Brand (optional)'; spec.style.width='100%';
    const grid=document.createElement('div'); grid.className='grid'; grid.appendChild(name); grid.appendChild(qty); grid.appendChild(spec);
    const actions=document.createElement('div'); actions.className='actions';
    const rm=document.createElement('button'); rm.type='button'; rm.className='btn icon'; rm.textContent='√ó'; rm.onclick=()=>card.remove();
    actions.appendChild(rm);
    card.appendChild(grid); card.appendChild(actions);
    name.addEventListener('click', ()=>openPicker(name,'materials'));
    return card;
  }

  function collectLines(containerSel){
    const out=[];
    $$(containerSel+' .line').forEach(c=>{
      const nameEl=c.querySelector('input[data-picker="materials"]');
      const qtyEl=c.querySelector('input[type="number"]');
      const specEl=c.querySelector('input[placeholder^="Spec"]');
      const name=nameEl?nameEl.value.trim():'';
      const qty=Number(qtyEl?qtyEl.value:0)||0;
      const spec=specEl? (specEl.value.trim()||'') : '';
      if (name) out.push({name:name, qty:qty, spec:spec});
    });
    return out;
  }

  function currentTab(){
    if ($('#panel-dashboard').style.display!=='none') return 'dashboard';
    if ($('#panel-out').style.display!=='none') return 'out';
    if ($('#panel-in').style.display!=='none') return 'in';
    if ($('#panel-adjust').style.display!=='none') return 'adjust';
    return 'purchase';
  }
  function showTab(which){
    ['#tab-dashboard','#tab-out','#tab-in','#tab-adjust','#tab-purchase'].forEach(s=>{ const b=$(s); if(b) b.classList.remove('active'); });
    ['#panel-dashboard','#panel-out','#panel-in','#panel-adjust','#panel-purchase'].forEach(s=>{ const p=$(s); p.style.display='none'; });
    $('#sharedCard').classList.add('hidden');

    if (which==='dashboard'){ $('#tab-dashboard').classList.add('active'); $('#panel-dashboard').style.display='flex'; $('#toolbar').classList.add('hidden'); loadDashboard(); }
    if (which==='out'){ $('#tab-out').classList.add('active'); $('#panel-out').style.display='flex'; $('#sharedCard').classList.remove('hidden'); $('#toolbar').classList.remove('hidden'); }
    if (which==='in'){ $('#tab-in').classList.add('active'); $('#panel-in').style.display='flex'; $('#toolbar').classList.remove('hidden'); }
    if (which==='adjust'){ $('#tab-adjust').classList.add('active'); $('#panel-adjust').style.display='flex'; $('#toolbar').classList.remove('hidden'); }
    if (which==='purchase'){ $('#tab-purchase').classList.add('active'); $('#panel-purchase').style.display='flex'; $('#toolbar').classList.remove('hidden'); loadPurchasingOlder(); }
  }

  function submit(){
    const tab = currentTab();
    if (tab==='dashboard'){ toast(STR[LANG].dashNoSubmit); return; }

    if (tab==='purchase'){
      const pp = {
        type:'PURCHASE',
        project: $('#PurProject').value.trim(),
        contractor: $('#PurContractor').value.trim(),
        needBy:  $('#PurNeedBy').value.trim(),
        priority: $('#PurPriority').value,
        note:     $('#PurNote').value.trim(),
        lines:    collectLines('#purLines')
      };
      if (!pp.lines.length){ toast(LANG==='th'?'‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£':'Add at least one line'); return; }
      apiPost('submitPurchaseRequest', pp, res=>{
        if(res && res.ok){ toast('Request sent ‚Ä¢ '+(res.docNo||'')); hardReset('purchase'); loadDashboard(); }
        else toast((res && res.message) || 'Error');
      });
      return;
    }

    const payload = {
      type: (tab==='out') ? 'OUT' : (tab==='in') ? 'IN' : 'ADJUST',
      project: (tab==='out') ? $('#ProjectInput').value.trim() : '',
      contractor: (tab==='out') ? $('#ContractorInput').value.trim() : '',
      requester: (tab==='out') ? $('#RequesterInput').value.trim() : '',
      note: (tab==='out') ? $('#Note').value.trim() : '',
      date: (tab==='in') ? $('#InDate').value.trim() : (tab==='out' ? $('#OutDate').value.trim() : ''),
      lines: (tab==='in') ? collectLines('#inLines') : (tab==='out') ? collectLines('#outLines') : collectLines('#adjLines')
    };
    if (!payload.lines.length){ toast(LANG==='th'?'‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£':'Add at least one line'); return; }

    apiPost('submitMovementBulk', payload, res=>{
      if(res && res.ok){ toast((LANG==='th'?'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‚Ä¢ ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ ':'Saved ‚Ä¢ Doc ')+(res.docNo||'')); hardReset(tab); loadDashboard(); }
      else toast((res && res.message) || 'Error');
    });
  }

  function hardReset(which){
    if (!which || which==='out'){ $('#outLines').innerHTML=''; $('#outLines').appendChild(outLine()); $('#Note').value=''; $('#OutDate').value=''; }
    if (!which || which==='in'){  $('#inLines').innerHTML='';  $('#inLines').appendChild(inLine());  $('#InDate').value=''; }
    if (!which || which==='adjust'){ $('#adjLines').innerHTML=''; $('#adjLines').appendChild(adjLine()); }
    if (!which || which==='purchase'){ $('#purLines').innerHTML=''; $('#purLines').appendChild(purLine()); $('#PurNote').value=''; $('#PurNeedBy').value=''; $('#PurContractor').value=''; }
    window.scrollTo({top:0,behavior:'smooth'});
  }

  // ===== Dashboard fills (unchanged logic, UI clamps) =====
  function loadDashboard(){
    apiGet('dash_LowStock', {}, list=>{
      const box = $('#lowStockList'); box.innerHTML='';
      if (!list || !list.length){ box.innerHTML = '<div class="rowitem"><span>No low stock üéâ</span></div>'; return clampList(box); }
      list.forEach(x=>{
        const row=document.createElement('div'); row.className='rowitem';
        row.innerHTML = '<div><strong>'+esc(x.name)+'</strong><div class="meta">Min '+(x.min==null?'-':x.min)+' ‚Ä¢ Stock '+esc(x.stock)+'</div></div>';
        box.appendChild(row);
      });
      clampList(box);
    });
    apiGet('dash_TopContractors', {}, list=>{
      const box = $('#topContractors'); box.innerHTML='';
      (list||[]).forEach(x=>{
        const row=document.createElement('div'); row.className='rowitem';
        row.innerHTML = '<div><strong>'+esc(x.contractor||'(unknown)')+'</strong><div class="meta">'+esc(x.project||'-')+' ‚Ä¢ Qty '+(x.qty||0)+'</div></div>';
        box.appendChild(row);
      });
      clampList(box);
    });
    apiGet('dash_TopItems', {}, list=>{
      const box = $('#topItems'); box.innerHTML='';
      (list||[]).forEach(x=>{
        const row=document.createElement('div'); row.className='rowitem';
        row.innerHTML = '<div><strong>'+esc(x.name)+'</strong><div class="meta">Used ‚Ä¢ '+esc(x.qty)+'</div></div>';
        box.appendChild(row);
      });
      clampList(box);
    });
    apiGet('dash_Recent', {}, rows=>{
      const box = $('#recentMoves'); box.innerHTML='';
      (rows||[]).forEach(x=>{
        const row=document.createElement('div'); row.className='rowitem';
        row.innerHTML = '<div><strong>'+esc(x.type)+' ‚Ä¢ '+esc(x.item)+'</strong><div class="meta">'+esc(x.ts)+' ‚Äî '+esc(x.doc)+' ‚Ä¢ Qty '+esc(x.qty)+'</div></div>';
        box.appendChild(row);
      });
      clampList(box);
    });
    apiGet('pur_Summary', {}, s=>{
      $('#kpiReq').textContent = (s && s.requests) ? s.requests : 0;
      $('#kpiLines').textContent = (s && s.lines) ? s.lines : 0;
      $('#kpiUrgent').textContent = (s && s.urgent) ? s.urgent : 0;
    });
    apiGet('pur_History', {}, rows=>{
      const sum = $('#purSummaryDetail'); sum.innerHTML='';
      (rows||[]).forEach(x=>{
        const row=document.createElement('div'); row.className='rowitem';
        row.innerHTML = '<div><strong>'+esc(x.docNo)+' ‚Ä¢ '+esc(x.project||'-')+'</strong>'+
                        '<div class="meta">üë∑ '+esc(x.contractor||'-')+' ‚Ä¢ üôã '+esc(x.requester||'-')+'</div>'+
                        '<div class="meta">üóì '+esc(x.ts)+' ‚Üí üìÜ '+esc(x.needBy||'-')+'</div></div>';
        sum.appendChild(row);
      });
      clampList(sum);

      const box = $('#purHistory'); box.innerHTML='';
      (rows||[]).forEach(x=>{
        const row=document.createElement('div'); row.className='rowitem';
        row.innerHTML = '<div><strong>'+esc(x.docNo)+' ‚Ä¢ '+esc(x.project||'-')+'</strong>'+
                        '<div class="meta">'+esc(x.ts)+' ‚Ä¢ NeedBy '+esc(x.needBy||'-')+' ‚Ä¢ '+esc(x.priority||'-')+' ‚Ä¢ '+esc(x.status||'-')+'</div>'+
                        '<div class="meta">Lines '+esc(x.lines)+' ‚Ä¢ Qty '+esc(x.totalQty)+' ‚Ä¢ üë∑ '+esc(x.contractor||'-')+' ‚Ä¢ üôã '+esc(x.requester||'-')+'</div></div>';
        box.appendChild(row);
      });
      clampList(box);
    });

    $$('.toggle button').forEach(btn=> btn.onclick = ()=>toggleClamp(btn));
  }

  // Purchasing older (accordion) ‚Äî same as previous version
  function loadPurchasingOlder(){
    apiGet('pur_History', {}, rows=>{
      const box=$('#purOlderList'); box.innerHTML='';
      (rows||[]).forEach(x=>{
        const acc=document.createElement('div'); acc.className='rowitem';
        acc.style.flexDirection='column'; acc.style.alignItems='stretch';
        const head=document.createElement('div');
        head.style.display='flex'; head.style.justifyContent='space-between'; head.style.cursor='pointer';
        head.innerHTML = '<span>'+esc(x.docNo)+' ‚Ä¢ '+esc(x.project||'-')+' ‚Ä¢ '+esc(x.ts)+'</span><span>‚Ä∫</span>';
        const body=document.createElement('div'); body.className='hidden';
        body.innerHTML = '<div class="meta">üë∑ '+esc(x.contractor||'-')+' ‚Ä¢ üôã '+esc(x.requester||'-')+' ‚Ä¢ NeedBy '+esc(x.needBy||'-')+'</div>'+
                         '<div id="doc-'+esc(x.docNo)+'">Loading‚Ä¶</div>';
        head.addEventListener('click', ()=>{
          const open = !body.classList.contains('hidden');
          if (open){ body.classList.add('hidden'); return; }
          const holder = body.querySelector('#doc-'+CSS.escape(x.docNo));
          apiGet('pur_DocLines', {docNo:x.docNo}, lines=>{
            const tbl = document.createElement('table'); tbl.className='table';
            tbl.innerHTML='<thead><tr><th>Item</th><th>Spec</th><th>Qty</th></tr></thead>';
            const tb=document.createElement('tbody');
            (lines||[]).forEach(li=>{
              const tr=document.createElement('tr');
              tr.innerHTML='<td>'+esc(li.item)+'</td><td>'+esc(li.spec||'')+'</td><td>'+esc(li.qty)+'</td>';
              tb.appendChild(tr);
            });
            tbl.appendChild(tb);
            holder.replaceWith(tbl);
          });
          body.classList.remove('hidden');
        });
        acc.appendChild(head); acc.appendChild(body);
        box.appendChild(acc);
      });
      clampList(box);
      const toggleBtn = document.querySelector('.toggle button[data-toggle="#purOlderList"]');
      if (toggleBtn) toggleBtn.onclick = ()=>toggleClamp(toggleBtn);
    });
  }

  // Events
  document.addEventListener('DOMContentLoaded', function(){
    // language
    $('#lang-en').addEventListener('click', ()=>{ LANG='en'; $('#lang-en').classList.add('active'); $('#lang-th').classList.remove('active'); applyLang(); });
    $('#lang-th').addEventListener('click', ()=>{ LANG='th'; $('#lang-th').classList.add('active'); $('#lang-en').classList.remove('active'); applyLang(); });

    // tabs
    $('#tab-dashboard').addEventListener('click', ()=>{ showTab('dashboard'); loadDashboard(); });
    $('#tab-out').addEventListener('click', ()=>{ showTab('out'); });
    $('#tab-in').addEventListener('click', ()=>{ showTab('in'); });
    $('#tab-adjust').addEventListener('click', ()=>{ showTab('adjust'); });
    $('#tab-purchase').addEventListener('click', ()=>{ showTab('purchase'); });

    // toolbar
    $('#addLineBtn').addEventListener('click', ()=>{
      const tab=currentTab();
      if (tab==='out') $('#outLines').appendChild(outLine());
      else if (tab==='in') $('#inLines').appendChild(inLine());
      else if (tab==='adjust') $('#adjLines').appendChild(adjLine());
      else if (tab==='purchase') $('#purLines').appendChild(purLine());
      else toast(STR[LANG].dashNoSubmit);
      bindPickerInputs();
    });
    $('#resetBtn').addEventListener('click', ()=>{ hardReset(currentTab()); bindPickerInputs(); });
    $('#submitBtn').addEventListener('click', submit);

    // load lookups
    apiGet('listMaterials', {}, a=>{ MATERIALS=a||[]; });
    apiGet('listProjects', {}, a=>{ PROJECTS=a||[]; });
    apiGet('listContractors', {}, a=>{ CONTRACTORS=a||[]; });
    apiGet('listRequesters', {}, a=>{ REQUESTERS=a||[]; });

    // initial UI
    hardReset();
    applyLang();
    showTab('dashboard');
    loadDashboard();
    bindPickerInputs();

    // attach pickers to header inputs
    $('#ProjectInput').addEventListener('click', ()=>openPicker($('#ProjectInput'),'projects'));
    $('#ContractorInput').addEventListener('click', ()=>openPicker($('#ContractorInput'),'contractors'));
    $('#RequesterInput').addEventListener('click', ()=>openPicker($('#RequesterInput'),'requesters'));
    $('#PurProject').addEventListener('click', ()=>openPicker($('#PurProject'),'projects'));
    $('#PurContractor').addEventListener('click', ()=>openPicker($('#PurContractor'),'contractors'));

    // quick add contractor/requester via plus buttons (uses picker add flow)
    $('#addContractorBtn').addEventListener('click', ()=>{
      openPicker($('#ContractorInput'),'contractors');
      pickerSearch.focus();
    });
    $('#addRequesterBtn').addEventListener('click', ()=>{
      openPicker($('#RequesterInput'),'requesters');
      pickerSearch.focus();
    });
  });
})();
</script>
</body>
</html>