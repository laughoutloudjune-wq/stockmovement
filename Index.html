<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
  <title>Inventory</title>
  <style>
    /* same Liquid Glass mobile-friendly styles from our last version */
    :root{
      --fs-xs: clamp(0.75rem, 1.2vw, 0.9rem);
      --fs-sm: clamp(0.9rem, 1.4vw, 1.05rem);
      --fs-md: clamp(1rem, 1.8vw, 1.2rem);
      --fs-lg: clamp(1.15rem, 2.2vw, 1.4rem);

      --space-1:.5rem; --space-2:.75rem; --space-3:1rem; --space-4:1.25rem;
      --radius: 1rem; --border:#e5e5ea;
      --bg:#f5f5f7; --card:#ffffff; --text:#111; --muted:#6b7280;
      --accent:#0a84ff; --accent-weak:#e5f0ff;
      --shadow: 0 0.05rem 0.15rem rgba(0,0,0,.06), 0 0.6rem 1.2rem rgba(0,0,0,.06);

      --container-max: 72rem;
      --toolbar-max: 44rem;
      --pad-x: max(4vw, 1rem);
      --pad-bottom: 10rem;
    }
    *,*::before,*::after{ box-sizing:border-box }
    html{ height:100%; font-size:16px; -webkit-text-size-adjust:100% }
    body{ min-height:100dvh; margin:0; font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif; background:var(--bg); color:var(--text) }

    .container{ position:relative; z-index:1; width:min(100%, 28rem); margin:0 auto; padding: calc(env(safe-area-inset-top) + var(--space-3)) var(--pad-x) calc(env(safe-area-inset-bottom) + var(--pad-bottom)); display:flex; flex-direction:column; gap:var(--space-3) }
    @media (min-width: 48rem){ .container{ width:min(100%, var(--container-max)) } }

    header{ display:flex; align-items:center; gap:var(--space-2) }
    header h1{ margin:0; font-size:var(--fs-lg); font-weight:800 }
    .spacer{ flex:1 }

    .lang{ display:flex; gap:.5rem }
    .lang button{ padding:.45rem .9rem; border-radius:9999px; border:1px solid var(--border); background:#fafafa; color:#111; font-weight:700; font-size:var(--fs-sm); cursor:pointer }
    .lang button.active{ background:var(--accent); color:#fff; border-color:var(--accent) }

    .tabs{ display:flex; gap:.5rem; padding:.4rem; overflow:auto; border:1px solid var(--border); border-radius:9999px; background:#f8f8fb; -webkit-overflow-scrolling:touch }
    .tabs button{ flex:0 0 auto; white-space:nowrap; padding:.6rem .9rem; border:none; border-radius:9999px; background:transparent; cursor:pointer; font-weight:800; color:#3a3a3c; font-size:var(--fs-sm) }
    .tabs button.active{ background:#fff; color:var(--accent); box-shadow:var(--shadow) }

    .toolbar{ position:fixed; left:50%; bottom:calc(env(safe-area-inset-bottom) + 0.75rem); transform:translateX(-50%); z-index:1000; width:min(100% - 2rem, var(--toolbar-max)); height:auto; display:inline-flex; align-items:center; gap:.5rem; padding:.65rem; border-radius:1rem; background:rgba(255,255,255,0.72); border:1px solid rgba(255,255,255,0.45); backdrop-filter:saturate(200%) blur(24px); -webkit-backdrop-filter:saturate(200%) blur(24px); box-shadow:0 10px 30px rgba(0,0,0,.12); pointer-events:auto; contain:layout paint }
    .toolbar.hidden{ display:none }
    .btn{ appearance:none; cursor:pointer; font-weight:800; font-size:var(--fs-sm); padding:.8rem 1rem; border-radius:.9rem; flex:1; border:1px solid rgba(255,255,255,.55); background:rgba(255,255,255,0.55); color:#111; box-shadow:inset 0 0 0 1px rgba(255,255,255,.6), 0 3px 8px rgba(0,0,0,.08); -webkit-tap-highlight-color:transparent; touch-action:manipulation }
    .btn.primary{ color:#fff; border-color:transparent; background:linear-gradient(145deg,#0a84ff,#4da3ff); box-shadow:0 6px 14px rgba(10,132,255,.28), inset 0 0 0 1px rgba(255,255,255,.2) }
    .btn.icon{ flex:0 0 auto; width:2.75rem; min-width:2.75rem; padding:.65rem 0; text-align:center }

    .card{ background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); padding:var(--space-3); display:flex; flex-direction:column; gap:var(--space-3) }
    .card h3{ margin:0; font-size:var(--fs-md) }

    .row{ display:flex; flex-wrap:wrap; gap:var(--space-3) }
    .row > *{ flex:1 1 14rem }

    label{ font-size:var(--fs-xs); color:var(--muted) }
    input,select,textarea{ width:100%; padding:.85rem .95rem; font-size:16px; background:#fff; color:#111; border:1px solid var(--border); border-radius:.9rem; outline:none }
    input:focus,select:focus,textarea:focus{ border-color:var(--accent); box-shadow:0 0 0 .2rem var(--accent-weak) }

    .lines{ display:flex; flex-direction:column; gap:.75rem }
    .line{ display:flex; flex-direction:column; gap:.75rem; padding:.75rem; border:1px dashed var(--border); border-radius:.9rem; background:#fff }
    .line .grid{ display:flex; flex-wrap:wrap; gap:.75rem }
    .line .grid > *{ flex:1 1 10rem }
    .actions{ display:flex; justify-content:flex-end }

    .list{ display:flex; flex-direction:column; gap:.6rem }
    .rowitem{ display:flex; justify-content:space-between; align-items:center; gap:.75rem; padding:.75rem .95rem; border:1px solid var(--border); border-radius:.9rem; background:#fff; font-size:var(--fs-sm) }
    .rowitem .meta{ color:var(--muted); font-size:var(--fs-xs) }

    .grid-dash{ display:flex; flex-direction:column; gap:var(--space-3) }
    @media (min-width: 80rem){ .grid-dash{ flex-direction:row } .grid-dash > :first-child{ flex:2 1 0 } .grid-dash > :last-child{ flex:1 1 0 } }

    .kpis{ display:flex; gap:.5rem; flex-wrap:wrap }
    .kpi{ flex:1 1 9rem; padding:.8rem; border-radius:.9rem; border:1px solid var(--border); background:#fff; box-shadow:var(--shadow) }
    .kpi .v{ font-size:1.25rem; font-weight:800 }

    .toast{ position:fixed; left:50%; bottom:calc(env(safe-area-inset-bottom) + 4.5rem); transform:translateX(-50%); background:#111; color:#fff; padding:.6rem .95rem; border-radius:.9rem; display:none; z-index:1500; font-size:var(--fs-sm) }
    .toast.show{ display:block }
    .hidden{ display:none !important }
  </style>
</head>
<body>
  <div class="container" id="app">
    <header>
      <h1 id="t_title">Inventory</h1>
      <div class="spacer"></div>
      <div class="lang">
        <button id="lang-en" class="active" type="button">EN</button>
        <button id="lang-th" type="button">TH</button>
      </div>
    </header>

    <div class="tabs">
      <button id="tab-dashboard" class="active" type="button">Dashboard</button>
      <button id="tab-out" type="button">OUT</button>
      <button id="tab-in" type="button">IN</button>
      <button id="tab-adjust" type="button">ADJUST</button>
      <button id="tab-purchase" type="button">PURCHASING</button>
    </div>

    <!-- DASHBOARD -->
    <section id="panel-dashboard" class="grid-dash">
      <div>
        <div class="card">
          <h3 id="t_dash_lowstock">Low stock</h3>
          <div class="list" id="lowStockList"></div>
        </div>
        <div class="card">
          <h3 id="t_dash_topcontractors">Top contractors (usage)</h3>
          <div class="list" id="topContractors"></div>
        </div>

        <!-- Purchasing Summary -->
        <div class="card">
          <h3 id="t_pur_summary">Summary</h3>
          <div class="kpis" id="purKpis">
            <div class="kpi"><div class="v" id="kpiReq">0</div><div>Requests</div></div>
            <div class="kpi"><div class="v" id="kpiLines">0</div><div>Lines</div></div>
            <div class="kpi"><div class="v" id="kpiUrgent">0</div><div>Urgent</div></div>
            <div class="kpi"><div class="v" id="kpiVendors">0</div><div>Vendors</div></div>
          </div>
        </div>
      </div>
      <div>
        <div class="card">
          <h3 id="t_dash_topitems">Top items</h3>
          <div class="list" id="topItems"></div>
        </div>
        <div class="card">
          <h3 id="t_dash_recent">Recent movements</h3>
          <div class="list" id="recentMoves"></div>
        </div>

        <!-- Purchasing History (all records) -->
        <div class="card">
          <h3 id="t_pur_history">History</h3>
          <div class="list" id="purHistory"></div>
        </div>
      </div>
    </section>

    <!-- OUT shared header -->
    <div class="card" id="sharedCard">
      <div class="row">
        <div>
          <label id="t_project">Project / Location</label>
          <input list="Projects" id="ProjectInput" placeholder="Search or pick" />
          <datalist id="Projects"></datalist>
        </div>
        <div>
          <label id="t_contractor">Contractor</label>
          <div style="display:flex;gap:.5rem;align-items:center">
            <input list="Contractors" id="ContractorInput" placeholder="Pick or add" />
            <datalist id="Contractors"></datalist>
            <button class="btn icon" id="addContractorBtn" type="button">+</button>
          </div>
        </div>
      </div>
      <div class="row">
        <div>
          <label id="t_requester">Requester</label>
          <div style="display:flex;gap:.5rem;align-items:center">
            <input list="Requesters" id="RequesterInput" placeholder="Pick or add" />
            <datalist id="Requesters"></datalist>
            <button class="btn icon" id="addRequesterBtn" type="button">+</button>
          </div>
        </div>
        <div>
          <label id="t_note">Note</label>
          <input id="Note" placeholder="Optional" />
        </div>
      </div>
    </div>

    <!-- OUT -->
    <div class="card" id="panel-out" style="display:none">
      <h3 id="t_out_title">Material OUT</h3>
      <div class="row">
        <div>
          <label id="t_out_date">Date</label>
          <input id="OutDate" type="date" />
        </div>
      </div>
      <div class="lines" id="outLines"></div>
    </div>

    <!-- IN -->
    <div class="card" id="panel-in" style="display:none">
      <h3 id="t_in_title">Material IN</h3>
      <div class="row">
        <div>
          <label id="t_date">Date received</label>
          <input id="InDate" type="date" />
        </div>
      </div>
      <div class="lines" id="inLines"></div>
    </div>

    <!-- ADJUST -->
    <div class="card" id="panel-adjust" style="display:none">
      <h3 id="t_adjust_title">Adjust</h3>
      <div class="lines" id="adjLines"></div>
    </div>

    <!-- PURCHASING (form only) -->
    <div class="card" id="panel-purchase" style="display:none">
      <h3 id="t_pur_title">Purchasing Request</h3>
      <div class="row" style="margin-top:.25rem">
        <div>
          <label id="t_pur_project">Project / Location</label>
          <input list="Projects" id="PurProject" placeholder="Search or pick" />
        </div>
        <div>
          <label id="t_pur_needby">Need by (date)</label>
          <input type="date" id="PurNeedBy" />
        </div>
      </div>
      <div class="row">
        <div>
          <label id="t_pur_vendor">Preferred vendor (optional)</label>
          <input id="PurVendor" placeholder="Type vendor name" />
        </div>
        <div>
          <label id="t_pur_priority">Priority</label>
          <select id="PurPriority">
            <option value="Normal">Normal</option>
            <option value="Urgent">Urgent</option>
            <option value="Critical">Critical</option>
          </select>
        </div>
      </div>
      <div class="lines" id="purLines"></div>
      <div class="row">
        <div>
          <label id="t_pur_note">Request note</label>
          <input id="PurNote" placeholder="Optional note for purchasing team" />
        </div>
      </div>
    </div>
  </div>

  <!-- Floating toolbar -->
  <div class="toolbar" id="toolbar" aria-live="polite" role="region">
    <button class="btn icon" id="addLineBtn" type="button" title="Add line">Ôºã</button>
    <button class="btn" id="resetBtn" type="button">Reset</button>
    <button class="btn primary" id="submitBtn" type="button">Submit</button>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script>
  (function(){
    /* ===== API CONFIG: paste your Web App URL here ===== */
    const API_URL = "https://script.google.com/macros/s/AKfycbxorXbbVhEW-xW1UPUxhBOJFfc02c2FmEnDbWWZSEEEp-L5OrK3uBF1nSFyuV-Ah58K/exec";

    /* ==== API helpers ==== 
       We use text/plain to avoid CORS preflight (OPTIONS).
       GET for reads, POST for writes (big payloads). */

    function apiGet(fn, payload, cb){
      const q = new URLSearchParams();
      q.set('fn', fn);
      if (payload && Object.keys(payload).length) q.set('payload', JSON.stringify(payload));
      fetch(API_URL + "?" + q.toString(), { method: 'GET' })
        .then(r => r.text())
        .then(t => safeJson(t))
        .then(data => cb && cb(data))
        .catch(err => console.error('GET '+fn+' error', err));
    }
    function apiPost(fn, payload, cb){
      fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        body: JSON.stringify({ fn: fn, payload: payload || {} })
      })
        .then(r => r.text())
        .then(t => safeJson(t))
        .then(data => cb && cb(data))
        .catch(err => console.error('POST '+fn+' error', err));
    }
    function safeJson(t){ try{ return JSON.parse(t); }catch(e){ return {ok:false,error:'Bad JSON from server'}; } }

    // ===== UI helpers =====
    function $(q){ return document.querySelector(q); }
    function $$(q){ return Array.prototype.slice.call(document.querySelectorAll(q)); }
    function toast(m){ var t=$('#toast'); t.textContent=m; t.classList.add('show'); setTimeout(function(){t.classList.remove('show');}, 2000); }
    function esc(v){ return (v==null)?'':String(v).replace(/[&<>"']/g,function(m){return({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]);}); }
    function val(sel){ var el=$(sel); return el? (el.value||'').trim() : ''; }

    // ===== i18n strings =====
    var STR = {
      en:{title:'Inventory',project:'Project / Location',contractor:'Contractor',requester:'Requester',note:'Note',item:'Item',qty:'Qty',addline:'Add line',outTitle:'Material OUT',outDate:'Date',inTitle:'Material IN',date:'Date received',adjTitle:'Adjust',purTitle:'Purchasing Request',purProject:'Project / Location',purNeedBy:'Need by (date)',purVendor:'Preferred vendor (optional)',purPriority:'Priority',purNote:'Request note',submitOut:'Submit OUT',submitIn:'Submit IN',submitAdj:'Submit ADJUST',submitPur:'Submit REQUEST',dashLow:'Low stock',dashTopCons:'Top contractors (usage)',dashTopItems:'Top items',dashRecent:'Recent movements',noLow:'No low stock üéâ',dashNoSubmit:'Nothing to submit on Dashboard',pickOrSearch:'Search or pick',pickOrAdd:'Pick or add',typeToSearch:'Type to search‚Ä¶',prev:'Prev: ',stock:'Stock: ',used:'Used',purSummary:'Summary',purHistory:'History'},
      th:{title:'‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ß‡∏±‡∏™‡∏î‡∏∏',project:'‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ / ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á',contractor:'‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏≤',requester:'‡∏ú‡∏π‡πâ‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å',note:'‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏',item:'‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£',qty:'‡∏à‡∏≥‡∏ô‡∏ß‡∏ô',addline:'‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£',outTitle:'‡πÄ‡∏ö‡∏¥‡∏Å‡∏≠‡∏≠‡∏Å',outDate:'‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà',inTitle:'‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤',date:'‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á',adjTitle:'‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å',purTitle:'‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏à‡∏±‡∏î‡∏ã‡∏∑‡πâ‡∏≠',purProject:'‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ / ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á',purNeedBy:'‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô (‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà)',purVendor:'‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)',purPriority:'‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô',purNote:'‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏',submitOut:'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ö‡∏¥‡∏Å‡∏≠‡∏≠‡∏Å',submitIn:'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤',submitAdj:'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å',submitPur:'‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏à‡∏±‡∏î‡∏ã‡∏∑‡πâ‡∏≠',dashLow:'‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î',dashTopCons:'‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏ö‡∏¥‡∏Å‡∏ö‡πà‡∏≠‡∏¢',dashTopItems:'‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏°',dashRecent:'‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î',noLow:'‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î üéâ',dashNoSubmit:'‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å',pickOrSearch:'‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å',pickOrAdd:'‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°',typeToSearch:'‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‚Ä¶',prev:'‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤: ',stock:'‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ',used:'‡πÉ‡∏ä‡πâ‡πÑ‡∏õ',purSummary:'‡∏™‡∏£‡∏∏‡∏õ',purHistory:'‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥'}
    };
    var LANG='en';
    function setText(sel,txt){ var el=$(sel); if(el) el.textContent=txt; }
    function applyLang(){
      var S=STR[LANG];
      setText('#t_title',S.title);
      setText('#t_dash_lowstock',S.dashLow);
      setText('#t_dash_topcontractors',S.dashTopCons);
      setText('#t_dash_topitems',S.dashTopItems);
      setText('#t_dash_recent',S.dashRecent);
      setText('#t_project',S.project); setText('#t_contractor',S.contractor); setText('#t_requester',S.requester); setText('#t_note',S.note);
      setText('#t_out_title',S.outTitle); setText('#t_out_date',S.outDate);
      setText('#t_in_title',S.inTitle);   setText('#t_date',S.date);
      setText('#t_adjust_title',S.adjTitle);
      setText('#t_pur_title',S.purTitle);
      setText('#t_pur_project',S.purProject);
      setText('#t_pur_needby',S.purNeedBy);
      setText('#t_pur_vendor',S.purVendor);
      setText('#t_pur_priority',S.purPriority);
      setText('#t_pur_note',S.purNote);
      setText('#t_pur_summary',S.purSummary);
      setText('#t_pur_history',S.purHistory);
      $$('.t_addline').forEach(function(el){ el.textContent=S.addline; });
      var pi=$('#ProjectInput'); if(pi) pi.placeholder=S.pickOrSearch;
      var ci=$('#ContractorInput'); if(ci) ci.placeholder=S.pickOrAdd;
      var ri=$('#RequesterInput'); if(ri) ri.placeholder=S.pickOrAdd;
      $$('.mat').forEach(function(i){ i.placeholder=S.typeToSearch; });
      var tab=currentTab();
      var label=(tab==='out')?S.submitOut:(tab==='in')?S.submitIn:(tab==='adjust')?S.submitAdj:S.submitPur;
      setText('#submitBtn',label);
    }

    // lookups cache
    var MATERIALS=[], PROJECTS=[], CONTRACTORS=[], REQUESTERS=[];
    function hydrateDatalist(sel, arr){
      var dl=$(sel); if(!dl) return; dl.innerHTML='';
      (arr||[]).forEach(function(v){ var o=document.createElement('option'); o.value=v; dl.appendChild(o); });
    }
    var materialsDL=document.createElement('datalist'); materialsDL.id='Materials'; document.body.appendChild(materialsDL);
    function hydrateMaterials(){
      var dl=document.getElementById('Materials') || materialsDL; dl.innerHTML='';
      (MATERIALS||[]).forEach(function(v){ var o=document.createElement('option'); o.value=v; dl.appendChild(o); });
    }

    // builders
    function makeItemInput(){ var i=document.createElement('input'); i.setAttribute('list','Materials'); i.placeholder=STR[LANG].typeToSearch; i.className='mat'; return i; }
    function makeQtyInput(ph){ var i=document.createElement('input'); i.type='number'; i.min='0'; i.step='any'; i.placeholder=ph||'0'; i.inputMode='decimal'; return i; }
    function makeRemoveBtn(){ var b=document.createElement('button'); b.type='button'; b.className='btn icon'; b.textContent='√ó'; b.addEventListener('click', function(e){ var p=findAncestor(e.target,'.line'); if(p) p.remove();}); return b; }
    function findAncestor(el, sel){ while(el && el!==document){ if(el.matches && el.matches(sel)) return el; el=el.parentNode; } return null; }

    function fetchStock(name, cb){ apiGet('getCurrentStock', {material: name}, cb); }

    function outLine(){
      var card=document.createElement('div'); card.className='line';
      var name=makeItemInput(); var qty=makeQtyInput('0');
      var grid=document.createElement('div'); grid.className='grid'; grid.appendChild(name); grid.appendChild(qty);
      var meta=document.createElement('div'); meta.className='rowitem meta'; meta.style.justifyContent='flex-start'; meta.textContent=STR[LANG].stock+'‚Äì';
      var actions=document.createElement('div'); actions.className='actions'; actions.appendChild(makeRemoveBtn());
      card.appendChild(grid); card.appendChild(meta); card.appendChild(actions);
      name.addEventListener('change', function(){ var v=name.value.trim(); if(!v) return; fetchStock(v,function(n){ meta.textContent=STR[LANG].stock+n; }); });
      return card;
    }
    function inLine(){
      var card=document.createElement('div'); card.className='line';
      var name=makeItemInput(); var qty=makeQtyInput('0');
      var grid=document.createElement('div'); grid.className='grid'; grid.appendChild(name); grid.appendChild(qty);
      var actions=document.createElement('div'); actions.className='actions'; actions.appendChild(makeRemoveBtn());
      card.appendChild(grid); card.appendChild(actions); return card;
    }
    function adjLine(){
      var card=document.createElement('div'); card.className='line';
      var name=makeItemInput(); var qty=makeQtyInput('¬±'); qty.placeholder='¬±';
      var grid=document.createElement('div'); grid.className='grid'; grid.appendChild(name); grid.appendChild(qty);
      var meta=document.createElement('div'); meta.className='rowitem meta'; meta.style.justifyContent='flex-start'; meta.textContent=STR[LANG].prev+'‚Äì';
      var actions=document.createElement('div'); actions.className='actions'; actions.appendChild(makeRemoveBtn());
      card.appendChild(grid); card.appendChild(meta); card.appendChild(actions);
      name.addEventListener('change', function(){ var v=name.value.trim(); if(!v) return; fetchStock(v,function(n){ meta.textContent=STR[LANG].prev+n; }); });
      return card;
    }
    function purLine(){
      var card=document.createElement('div'); card.className='line';
      var name=makeItemInput(); var qty=makeQtyInput('0'); var spec=document.createElement('input'); spec.placeholder='Spec / Brand (optional)'; spec.style.width='100%';
      var grid=document.createElement('div'); grid.className='grid'; grid.appendChild(name); grid.appendChild(qty); grid.appendChild(spec);
      var actions=document.createElement('div'); actions.className='actions'; actions.appendChild(makeRemoveBtn());
      card.appendChild(grid); card.appendChild(actions);
      return card;
    }

    function collectLines(containerSel){
      var out=[];
      $$(containerSel+' .line').forEach(function(c){
        var nameEl=c.querySelector('.mat');
        var qtyEl=c.querySelector('input[type="number"]');
        var specEl=c.querySelector('input[placeholder^="Spec"]');
        var name=nameEl?nameEl.value.trim():'';
        var qty=Number(qtyEl?qtyEl.value:0)||0;
        var spec=specEl? (specEl.value.trim()||'') : '';
        if (name) out.push({name:name, qty:qty, spec:spec});
      });
      return out;
    }

    // tabs
    function currentTab(){
      if ($('#panel-dashboard').style.display!=='none') return 'dashboard';
      if ($('#panel-out').style.display!=='none') return 'out';
      if ($('#panel-in').style.display!=='none') return 'in';
      if ($('#panel-adjust').style.display!=='none') return 'adjust';
      return 'purchase';
    }
    function showTab(which){
      ['#tab-dashboard','#tab-out','#tab-in','#tab-adjust','#tab-purchase'].forEach(function(s){ var b=$(s); if(b) b.classList.remove('active'); });
      ['#panel-dashboard','#panel-out','#panel-in','#panel-adjust','#panel-purchase'].forEach(function(s){ var p=$(s); if(p) p.style.display='none'; });
      $('#sharedCard').classList.add('hidden');

      if (which==='dashboard'){ $('#tab-dashboard').classList.add('active'); $('#panel-dashboard').style.display='flex'; $('#toolbar').classList.add('hidden'); loadDashboard(); }
      if (which==='out'){ $('#tab-out').classList.add('active'); $('#panel-out').style.display='flex'; $('#sharedCard').classList.remove('hidden'); $('#toolbar').classList.remove('hidden'); }
      if (which==='in'){ $('#tab-in').classList.add('active'); $('#panel-in').style.display='flex'; $('#toolbar').classList.remove('hidden'); }
      if (which==='adjust'){ $('#tab-adjust').classList.add('active'); $('#panel-adjust').style.display='flex'; $('#toolbar').classList.remove('hidden'); }
      if (which==='purchase'){ $('#tab-purchase').classList.add('active'); $('#panel-purchase').style.display='flex'; $('#toolbar').classList.remove('hidden'); }

      var S=STR[LANG];
      var label=(which==='out')?S.submitOut:(which==='in')?S.submitIn:(which==='adjust')?S.submitAdj:S.submitPur;
      setText('#submitBtn',label);
    }

    // submit
    function submit(){
      var tab=currentTab();
      if (tab==='dashboard'){ toast(STR[LANG].dashNoSubmit); return; }

      if (tab==='purchase'){
        var pp = {
          type:'PURCHASE',
          project: val('#PurProject'),
          needBy:  val('#PurNeedBy'),
          vendor:  val('#PurVendor'),
          priority: val('#PurPriority'),
          note:    val('#PurNote'),
          lines:   collectLines('#purLines')
        };
        if (!pp.lines.length){ toast(LANG==='th'?'‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£':'Add at least one line'); return; }
        apiPost('submitPurchaseRequest', pp, function(res){
          if(res && res.ok){ toast('Request sent ‚Ä¢ ' + (res.docNo||'')); hardReset('purchase'); loadDashboard(); }
          else { toast((res && res.message) || 'Error'); }
        });
        return;
      }

      var payload = {
        type: (tab==='out') ? 'OUT' : (tab==='in') ? 'IN' : 'ADJUST',
        project: (tab==='out') ? val('#ProjectInput') : '',
        contractor: (tab==='out') ? val('#ContractorInput') : '',
        requester: (tab==='out') ? val('#RequesterInput') : '',
        note: (tab==='out') ? val('#Note') : '',
        date: (tab==='in') ? val('#InDate') : (tab==='out' ? val('#OutDate') : ''),
        lines: (tab==='in') ? collectLines('#inLines') : (tab==='out') ? collectLines('#outLines') : collectLines('#adjLines')
      };
      if (!payload.lines.length){ toast(LANG==='th'?'‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£':'Add at least one line'); return; }

      apiPost('submitMovementBulk', payload, function(res){
        if(res && res.ok){ toast((LANG==='th'?'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‚Ä¢ ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ ':'Saved ‚Ä¢ Doc ')+(res.docNo||'')); hardReset(tab); loadDashboard(); }
        else { toast((res && res.message) || 'Error'); }
      });
    }

    function hardReset(which){
      if (!which || which==='out'){ $('#outLines').innerHTML=''; $('#outLines').appendChild(outLine()); $('#Note').value=''; $('#OutDate').value=''; }
      if (!which || which==='in'){  $('#inLines').innerHTML='';  $('#inLines').appendChild(inLine());  $('#InDate').value=''; }
      if (!which || which==='adjust'){ $('#adjLines').innerHTML=''; $('#adjLines').appendChild(adjLine()); }
      if (!which || which==='purchase'){ $('#purLines').innerHTML=''; $('#purLines').appendChild(purLine()); $('#PurNote').value=''; $('#PurVendor').value=''; $('#PurNeedBy').value=''; }
      window.scrollTo({top:0,behavior:'smooth'});
    }

    // dashboard
    function loadDashboard(){
      apiGet('dash_LowStock', {}, fillLowStock);
      apiGet('dash_TopContractors', {}, fillTopContractors);
      apiGet('dash_TopItems', {}, fillTopItems);
      apiGet('dash_Recent', {}, fillRecent);
      apiGet('pur_Summary', {}, renderPurchaseSummary);
      apiGet('pur_History', {}, renderPurchaseHistory);
    }
    function fillLowStock(list){
      var box = $('#lowStockList'); box.innerHTML='';
      if (!list || !list.length){ box.innerHTML = '<div class="rowitem"><span>'+STR[LANG].noLow+'</span></div>'; return; }
      list.forEach(function(x){
        var row = document.createElement('div'); row.className='rowitem';
        row.innerHTML = '<div><strong>'+esc(x.name)+'</strong><div class="meta">Min '+(x.min==null?'-':x.min)+' ‚Ä¢ '+STR[LANG].stock+esc(x.stock)+'</div></div>';
        box.appendChild(row);
      });
    }
    function fillTopContractors(list){
      var box = $('#topContractors'); box.innerHTML='';
      (list||[]).forEach(function(x){
        var row = document.createElement('div'); row.className='rowitem';
        var meta = (x.project||'-')+' ‚Ä¢ Qty '+(x.qty||0);
        row.innerHTML = '<div><strong>'+esc(x.contractor||'(unknown)')+'</strong><div class="meta">'+esc(meta)+'</div></div>';
        box.appendChild(row);
      });
    }
    function fillTopItems(list){
      var box = $('#topItems'); box.innerHTML='';
      (list||[]).forEach(function(x){
        var row = document.createElement('div'); row.className='rowitem';
        row.innerHTML = '<div><strong>'+esc(x.name)+'</strong><div class="meta">'+STR[LANG].used+' ‚Ä¢ '+esc(x.qty)+'</div></div>';
        box.appendChild(row);
      });
    }
    function fillRecent(rows){
      var box = $('#recentMoves'); box.innerHTML='';
      (rows||[]).forEach(function(x){
        var row = document.createElement('div'); row.className='rowitem';
        row.innerHTML = '<div><strong>'+esc(x.type)+' ‚Ä¢ '+esc(x.item)+'</strong><div class="meta">'+esc(x.ts)+' ‚Äî '+esc(x.doc)+' ‚Ä¢ Qty '+esc(x.qty)+'</div></div>';
        box.appendChild(row);
      });
    }
    function renderPurchaseSummary(s){
      setText('#kpiReq', (s && s.requests) ? s.requests : 0);
      setText('#kpiLines', (s && s.lines) ? s.lines : 0);
      setText('#kpiUrgent', (s && s.urgent) ? s.urgent : 0);
      setText('#kpiVendors', (s && s.vendors) ? s.vendors : 0);
    }
    function renderPurchaseHistory(rows){
      var box = $('#purHistory'); box.innerHTML='';
      if (!rows || !rows.length){
        box.innerHTML = '<div class="rowitem"><div>No history</div></div>';
        return;
      }
      rows.forEach(function(x){
        var row = document.createElement('div'); row.className='rowitem';
        row.innerHTML =
          '<div><strong>'+esc(x.docNo)+' ‚Ä¢ '+esc(x.project||'-')+'</strong>'+
          '<div class="meta">'+esc(x.ts)+' ‚Ä¢ NeedBy '+esc(x.needBy||'-')+' ‚Ä¢ '+esc(x.priority||'-')+' ‚Ä¢ '+esc(x.status||'-')+'</div>'+
          '<div class="meta">Lines '+esc(x.lines)+' ‚Ä¢ Qty '+esc(x.totalQty)+' ‚Ä¢ Vendor '+esc(x.vendor||'-')+'</div></div>';
        box.appendChild(row);
      });
    }

    // init events
    document.addEventListener('DOMContentLoaded', function(){
      // language
      $('#lang-en').addEventListener('click', function(){ LANG='en'; $('#lang-en').classList.add('active'); $('#lang-th').classList.remove('active'); applyLang(); });
      $('#lang-th').addEventListener('click', function(){ LANG='th'; $('#lang-th').classList.add('active'); $('#lang-en').classList.remove('active'); applyLang(); });

      // tabs
      $('#tab-dashboard').addEventListener('click', function(){ showTab('dashboard'); loadDashboard(); });
      $('#tab-out').addEventListener('click', function(){ showTab('out'); });
      $('#tab-in').addEventListener('click', function(){ showTab('in'); });
      $('#tab-adjust').addEventListener('click', function(){ showTab('adjust'); });
      $('#tab-purchase').addEventListener('click', function(){ showTab('purchase'); });

      // toolbar
      $('#addLineBtn').addEventListener('click', function(){
        var tab=currentTab();
        if (tab==='out') $('#outLines').appendChild(outLine());
        else if (tab==='in') $('#inLines').appendChild(inLine());
        else if (tab==='adjust') $('#adjLines').appendChild(adjLine());
        else if (tab==='purchase') $('#purLines').appendChild(purLine());
        else toast(STR[LANG].dashNoSubmit);
      });
      $('#resetBtn').addEventListener('click', function(){ hardReset(currentTab()); });
      $('#submitBtn').addEventListener('click', submit);

      // load lookups from API
      apiGet('listMaterials', {}, function(a){ MATERIALS=a||[]; document.body.appendChild(materialsDL); hydrateMaterials(); });
      apiGet('listProjects', {}, function(a){ PROJECTS=a||[]; hydrateDatalist('#Projects',PROJECTS); });
      apiGet('listContractors', {}, function(a){ CONTRACTORS=a||[]; hydrateDatalist('#Contractors',CONTRACTORS); });
      apiGet('listRequesters', {}, function(a){ REQUESTERS=a||[]; hydrateDatalist('#Requesters',REQUESTERS); });

      hardReset();
      applyLang();
      showTab('dashboard');
      loadDashboard();
    });
  })();
  </script>
</body>
</html>
